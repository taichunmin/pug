<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>ien.com.tw 設備狀態</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,body,h1,h2,h3,h4,h5,h6{font-family:"Noto Sans TC",sans-serif}.letter-spacing-n15{letter-spacing:-1.5px}.font-size-dot8{font-size:80%}</style></head><body><div class="container my-3 text-monospace" id="app" v-cloak><h3 class="text-center mb-3" v-if="!updatedAt">正在更新資料...</h3><h3 class="text-center mb-3" :class="(cur ?? 0) - (updatedAt ?? 0) >= 5e3 ? 'text-danger' : ''" v-else>更新於 {{ updatedAt?.format('HH:mm') }} ({{ formatDuration(cur - updatedAt) }})</h3><div class="table-responsive"><table class="text-center table table-sm table-bordered table-monospace"><thead class="font-size-dot8 thead-dark"><tr><th class="text-nowrap" scope="col" style="min-width:4rem">名稱</th><th class="text-nowrap" scope="col" style="width:20%">溫度</th><th class="text-nowrap" scope="col" style="width:20%">日照強度</th><th class="text-nowrap" scope="col" style="width:20%">RA值</th></tr></thead><tbody><template v-for="device of _.map(devices, tagEval)"><tr><td class="align-middle" rowspan="2">{{ device.名稱 }}<a :href="`https://ien.com.tw/portal/iengcHTML5/canvas.html?customerid=${device.編號}&page=0`" class="ml-2" target="_blank" v-if="device.編號"><i class="fa fa-external-link"></i></a></td><td class="text-nowrap font-size-dot8 letter-spacing-n15"><i class="fa fa-thermometer-half"></i> {{ _.isNil(device.溫度) ? '?' : _.round(device.溫度, 1) }} ℃</td><td class="text-nowrap font-size-dot8 letter-spacing-n15"><i class="fa fa-sun-o"></i> {{ _.isNil(device.日照強度) ? '?' : _.round(device.日照強度, 1) }} W/m²</td><td class="text-nowrap font-size-dot8 letter-spacing-n15"><i class="fa fa-tachometer"></i> {{ _.isNil(device.RA值) ? '?' : _.round(device.RA值, 1) }} %</td></tr><tr><td class="px-3 text-left" colspan="3"><template v-for="dp of [progressPercent(device.交流輸出功率, device.交流輸出功率上限)]"><div class="font-size-dot8 d-flex justify-content-between"><div class="text-nowrap text-muted"><i class="fa fa-random"></i> 交流輸出功率</div><div class="text-nowrap letter-spacing-n15">{{ _.round(device.交流輸出功率, 1) }} / {{ _.round(device.交流輸出功率上限, 1) }} ({{ _.round(dp, 1) }} %)</div></div><div class="progress" style="height:.5rem"><div class="progress-bar" :style="{ 'background-color': '#1fb52d', width: `${_.clamp(dp, .1, 40)}%` }"></div><div class="progress-bar" :style="{ 'background-color': '#ebeb1f', width: `${_.clamp(dp, 60) - 40}%` }" v-if="dp >= 40"></div><div class="progress-bar" :style="{ 'background-color': '#eb631f', width: `${_.clamp(dp, 80) - 60}%` }" v-if="dp >= 60"></div><div class="progress-bar" :style="{ 'background-color': '#eb1f1f', width: `${_.clamp(dp, 100) - 80}%` }" v-if="dp >= 80"></div></div></template><div class="font-size-dot8 d-flex justify-content-between mt-2"><div class="text-nowrap text-muted"><i class="fa fa-heartbeat"></i> 逆變器狀態</div><div class="d-flex align-items-center flex-wrap justify-content-end"><template v-for="inv, invIdx of device.invs"><span class="mb-1 badge badge-pill ml-1 badge-success" title="運轉中" v-if="inv.狀態 === 2">{{ invIdx }}</span><span class="mb-1 badge badge-pill ml-1 badge-warning" title="無直流" v-else-if="inv.狀態 === 3">{{ invIdx }}</span><span class="mb-1 badge badge-pill ml-1 badge-danger" title="異常" v-else-if="inv.狀態 === 4">{{ invIdx }}</span><span class="mb-1 badge badge-pill ml-1 badge-secondary" :title="`其他 (${inv.狀態})`" v-else>{{ invIdx }}</span></template></div></div><template v-for="directMax of [_.max(_.map(device.invs, inv => _.keys(inv.直流輸入電流).length))]"><details class="mt-1" v-if="directMax > 0"><summary class="font-size-dot8 letter-spacing-n15">逆變器「直流輸入電流」表格</summary><table class="mb-1 table table-sm text-center"><thead class="thead-dark"><tr><th class="font-size-dot8" scope="col"> </th><th class="text-nowrap font-size-dot8" scope="col" v-for="directIdx of directMax">{{ directIdx }}</th></tr></thead><tbody v-for="invIdxMax of [_.keys(device.invs).length]"><tr v-for="invIdx of invIdxMax"><th class="text-nowrap font-size-dot8" scope="row">INV {{ invIdx }}</th><td v-for="directIdx of directMax"><div class="font-size-dot8" v-if="!_.hasIn(device.invs, `${invIdx}.直流輸入電流.${directIdx}`)"> </div><template v-for="directCurrent of [device.invs[invIdx].直流輸入電流[directIdx] ?? null]" v-else><div class="text-nowrap font-size-dot8 letter-spacing-n15">{{ _.isNil(directCurrent) ? '?' : _.round(directCurrent, 1) }} A</div></template></td></tr></tbody></table></details></template></td></tr></template></tbody></table></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script>const isFiniteStr=t=>_.isString(t)&&/^([1-9]\d*|0)([.]\d+)?$/.test(t),isHex32=t=>/^[0-9a-fA-F]{32}$/.test(t),sleep=e=>new Promise(t=>setTimeout(t,e));window.vm=new Vue({el:"#app",data:{cur:null,devices:{},ienTags:new Map,updatedAt:null},async mounted(){await this.init()},methods:{async init(){try{this.showLoading("請稍候…","正在載入中"),await this.initConf(),await this.updateIenValue(),this.loopFn(()=>this.updateIenValue()),this.loopFn(()=>{this.cur=dayjs()}),Swal.close()}catch(t){console.error(t),await Swal.fire({icon:"error",title:"發生錯誤",text:t.message}),location.reload()}},async initConf(){var[t,e]=await Promise.all([this.getCsv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTLb0um9gIogNQ9gLxtGoMDyjto1C3FoROTPS-q3nz1KQrc7lMLiAeaNVbgmwqbp4ioQ6tITfYokXgz/pub?gid=0&single=true&output=csv"),this.getCsv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTLb0um9gIogNQ9gLxtGoMDyjto1C3FoROTPS-q3nz1KQrc7lMLiAeaNVbgmwqbp4ioQ6tITfYokXgz/pub?gid=405324759&single=true&output=csv")]);console.log({confDevices:t,confInverters:e});for(const u of t){var s,i,a,o={invs:{}};for([s,i]of _.toPairs(u))[s,i]=_.map([s,i],_.trim),isHex32(i)&&this.ienTags.set(i,null),/^逆變器\d+$/.test(s)?isHex32(i)&&(a=_.toSafeInteger(s.slice(3)),_.set(o,"invs."+a,{"狀態":i,"直流輸入電流":{}})):isFiniteStr(i)?_.set(o,s,_.toFinite(i)):_.set(o,s,""===i?null:i);this.$set(this.devices,o.名稱,o)}var n=t=>{if(t=_.trim(t),!isHex32(t))return null;for(const e of _.values(this.devices))for(const s of _.values(e.invs))if(s.狀態===t)return s;return null};for(const g of e){var r=n(g.逆變器);if(r)for(var[l,c]of _.toPairs(g))[l,c]=_.map([l,c],_.trim),isHex32(c)&&(this.ienTags.set(c,null),/^直流輸入電流\d+$/.test(l)&&(l=_.toSafeInteger(l.slice(6)),this.$set(r.直流輸入電流,l,c)))}},async loopFn(t,e=500){if(t&&_.isFunction(t))for(;;)await t(),await sleep(e)},async updateIenValue(){await Promise.all(_.map(_.chunk([...this.ienTags.keys()],100),async t=>{try{var e="<?xml version='1.0' encoding='UTF-8'?><request xmlns='http://chttl.com/iengc/core' method='getTagValue' customerid='2944' querylevel='1'>"+_.map(t,t=>`<tag id='${t}'/>`).join("")+"</request>";const s=_.get(await axios.post("https://ien.com.tw/portal/GraphicController",Qs.stringify({data:e}),{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}),"data");for(const i of s.matchAll(/id="([^"]+)"[^>]+result="([^"]+)"[^>]+value="([^"]+)"/g))try{let t="0"===i[2]?_.trim(i[3]):null;isFiniteStr(t)&&(t=_.toFinite(t)),this.ienTags.set(i[1],t)}catch(t){console.error(t),console.log("match = "+JSON.stringify(i.slice(1)))}}catch(t){console.error(t)}})),this.updatedAt=dayjs()},async getCsv(t,e=3e4){t=_.trim(_.get(await axios.get(t,{params:{cachebust:_.floor(Date.now()/e)}}),"data"));return _.get(Papa.parse(t,{encoding:"utf8",header:!0}),"data",[])},tagEval(t){return _.isArray(t)?_.map(t,this.tagEval):_.isPlainObject(t)?_.mapValues(t,this.tagEval):_.isString(t)&&isHex32(t)?this.ienTags.get(t):t},formatDuration(t){return _.isNaN(t)?"? 秒前":(t=Math.max(0,t))<1e5?_.floor(t/1e3)+" 秒前":t<6e6?_.floor(t/6e4,1)+" 分鐘前":void 0},progressPercent(t,e){[t,e]=_.map([t,e],_.toFinite);t=_.clamp(t/e*100,100);return _.isNaN(t)?0:t},showLoading(t,e){Swal.fire({title:t,text:e,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}})}}});</script></body></html>