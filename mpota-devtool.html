<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>微程式韌體藍牙更新</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><meta content="2133031763635285" property="fb:app_id"><meta content="微程式韌體藍牙更新" property="og:description"><meta content="zh_TW" property="og:locale"><meta content="筆記國度" property="og:site_name"><meta content="微程式韌體藍牙更新" property="og:title"><meta content="website" property="og:type"><meta content="https://taichunmin.idv.tw/pug/mpota-devtool.html" property="og:url"><style>[v-cloak]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,body,h1,h2,h3,h4,h5,h6{font-family:"Noto Sans TC",sans-serif}.card .input-group-sm .input-group-text{letter-spacing:-1px;min-width:4.5rem}</style></head><body><div class="container-fluid my-3" id="app" style="max-width:760px" v-cloak><h3 class="mb-3 text-center">微程式韌體藍牙更新</h3><div class="card mb-4"><div class="card-body text-monospace"><h5 class="card-title">操作</h5><button @click="btnGetFirmwareInfo" class="mt-2 btn btn-block btn-outline-info" type="button"><span class="fa fa-fw fa-info-circle"></span> 取得裝置資訊</button><button @click="btnUploadFirmware" class="mt-2 btn btn-block btn-outline-primary" type="button"><span class="fa fa-fw fa-upload"></span> 執行韌體更新</button><button @click="btnReset" class="mt-2 btn btn-block btn-outline-danger" type="button"><span class="fa fa-fw fa-trash-o"></span> 重設本頁資料</button></div></div><div class="card mb-4"><div class="card-body text-monospace"><h5 class="card-title my-0" @click="h.showConfig = !h.showConfig">韌體設定</h5><template v-if="h.showConfig"><div class="was-validated"><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">硬體型號</span></div><input class="form-control" inputmode="email" maxlength="16" pattern="\w{1,12}" required v-model="h.model"></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">韌體版本</span></div><input class="form-control" inputmode="email" maxlength="12" pattern="\w{1,12}" required v-model="h.version"></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">韌體網址</span></div><textarea class="form-control" inputmode="email" pattern=".+" required rows="4" v-model="h.fw"></textarea></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">UUID服務</span></div><input class="form-control" inputmode="email" maxlength="36" pattern="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}" required v-model="h.uuidService"></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">UUID寫入</span></div><input class="form-control" inputmode="email" maxlength="36" pattern="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}" required v-model="h.uuidWrite"></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">UUID通知</span></div><input class="form-control" inputmode="email" maxlength="36" pattern="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}" required v-model="h.uuidNotify"></div></div><div class="mt-2 d-flex mx-n2"><div class="input-group input-group-sm flex-fill mx-2"><div class="input-group-prepend"><span class="input-group-text justify-content-end">封包大小</span></div><input class="form-control" inputmode="number" type="number" v-model.number="h.blockSize"></div><div class="input-group input-group-sm flex-fill mx-2"><div class="input-group-prepend"><span class="input-group-text justify-content-end">確認頻率</span></div><input class="form-control" inputmode="number" type="number" v-model.number="h.ackFreq"></div></div></template></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script>const ERRCODE={2001:"低電量無法更新",2002:"韌體型號不符",2003:"資料傳輸方式有誤",2004:"更新流程有誤",4001:"更新檔寫入失敗",4002:"更新檔讀取失敗",4003:"資料清除失敗",8001:"更新檔驗證失敗 8001",8002:"更新檔驗證失敗 8002",8003:"更新檔驗證失敗 8003"},sleep=(window.errToPlainObj=(()=>{const t=["address","code","data","dest","errno","info","message","name","path","port","reason","response.data","response.headers","response.status","stack","status","statusCode","statusMessage","syscall"];return e=>_.pick(e,t)})(),window.htmlEscape=(()=>{const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e=>e.replace(/[&<>"']/g,e=>t[e])})(),t=>new Promise(e=>{setTimeout(e,t)}));window.vm=new Vue({el:"#app",data:{bleCharNotify:null,bleCharWrite:null,bleService:null,device:null,h:{ackFreq:16,blockSize:16,fw:"https://gcs-youbike2-linebot.taichunmin.idv.tw/ma2004b-firmwares/hash_MA2004B_v1_0_r3.bin",model:"MA2004B",showConfig:!1,uuidNotify:"7e400003-b5a3-f393-e0a9-e50e24dcca9e",uuidService:"7e400001-b5a3-f393-e0a9-e50e24dcca9e",uuidWrite:"7e400002-b5a3-f393-e0a9-e50e24dcca9e",version:"v1_0_r3"}},async mounted(){try{var e=JSON5.parse(localStorage.getItem(location.pathname));e&&this.$set(this,"h",{...this.h,...e})}catch(e){}this.$watch("h",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.h))},{deep:!0})},methods:{async btnGetFirmwareInfo(){try{this.showLoading("請稍候","搜尋裝置中…"),await this.bleSearchDevice(),this.showLoading("請稍候","取得裝置資訊中…");var e=await this.bleGetFirmwareInfo(this.h.model);await Swal.fire({icon:"success",title:"裝置資訊取得成功",html:`<pre class="d-inline-block text-left">更新次數: ${e.updatedCnt}
韌體版本: ${window.htmlEscape(e.version)}</pre>`})}catch(e){console.error("btnGetFirmwareInfo = "+JSON.stringify(window.errToPlainObj(e))),await Swal.fire({icon:"error",title:"裝置資訊取得失敗",text:e.message})}finally{await this.bleDisconnect()}},async btnUploadFirmware(){try{this.showLoading("請稍候","搜尋裝置及下載韌體中…");const{ackFreq:s,blockSize:c}=this.h;if(!_.inRange(c,4,16384))throw new Error("blockSize 必須介於 0x4 和 0x3fff 之間");let r;await Promise.all([this.bleSearchDevice(),(async()=>{r=await _.get(await axios.get(this.h.fw,{params:{cachebust:_.floor(Date.now()/864e5)},responseType:"blob"}),"data").arrayBuffer(),this.logTime(`韌體更新檔下載成功，大小為 ${r.byteLength} bytes`);var e,t=c-r.byteLength%c;t<c&&(e=new ArrayBuffer(r.byteLength+t),new Uint8Array(e).set(new Uint8Array(r)),new Uint8Array(e,r.byteLength).fill(255),r=e,this.logTime(`韌體更新檔後面填充了 ${t} bytes`))})()]),this.showLoading("請稍候","取得裝置資訊中…");var e=await this.bleGetFirmwareInfo(this.h.model);if(e.version===this.h.version)if(!(await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"取消更新",confirmButtonColor:"#d33",confirmButtonText:"強制更新",focusCancel:!0,icon:"warning",reverseButtons:!0,showCancelButton:!0,text:`韌體版本已經是 ${e.version}，是否強制更新？`})).value)return;this.showLoading("請稍候","正在上傳韌體…");const l=r.byteLength/c,h=(this.logTime(`設定韌體傳輸參數: 確認頻率 ${s}，每個封包 ${c} bytes，共 ${l} 個封包`),await this.bleUploadFirmwareStep1(s,c,l),(()=>{const r={max:l};return e=>{var t=Date.now();_.toSafeInteger(r.expiredAt)>=t||(r.expiredAt=t+5e3,t=(e=Math.min(Math.max(0,e),r.max))===r.max?100:_.floor(e/r.max*100),this.showLoading("韌體更新進度",`${e} / ${r.max} (${t}%)`))}})());for(let e=0;e<l;e++){h(e);var t=(e+1)%s==0,i=await this.bleUploadFirmwareStep2(r,e*c,c,t);if(t){var n=s*c,a=(e+1-s)*c,o=_.reduce(new Uint8Array(r,a,n),(e,t)=>e^t,0);if(o!==i.crc)throw new Error(`crc 驗證失敗: crcStart = ${a}, crcLen = ${n}, crc = ${o}, res.crc = `+i.crc)}}await this.bleUploadFirmwareStep3(),await Swal.fire({icon:"success",title:"韌體更新成功"})}catch(e){console.error("btnUploadFirmware = "+JSON.stringify(window.errToPlainObj(e))),await Swal.fire({icon:"error",title:"韌體更新失敗",text:e.message})}finally{await this.bleDisconnect()}},async btnReset(e=!0){if(!e||(e=await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"保持原樣",confirmButtonColor:"#d33",confirmButtonText:"重設資料",focusCancel:!0,icon:"warning",reverseButtons:!0,showCancelButton:!0,text:"是否重設本頁面的資料？"})).value)return localStorage.removeItem(location.pathname),location.reload(),new Promise(e=>{})},bleNewRequest({ack:e=!0,cmd:t,len:r=0}){if(!_.inRange(t,0,256))throw new Error("cmd 有誤");if(!_.inRange(r,0,16384))throw new Error("len 有誤");var i=new ArrayBuffer(r+4);const n={buffer:i,len:r,header:new DataView(i,0,4),body:new DataView(i,4)};return n.header.setUint8(0,128),n.header.setUint16(1,(e?32768:0)+r,!0),n.header.setUint8(3,t),n},async bleGetFirmwareInfo(e){if(!_.isString(e))throw new Error("model 有誤");var e=(new TextEncoder).encode(e).buffer,t=this.bleNewRequest({cmd:240,len:e.byteLength});new Uint8Array(t.buffer,4).set(new Uint8Array(e));const r=await this.bleSendRequest({req:t});if(20===r.len&&20===_.sumBy(new Uint8Array(r.buffer,4),e=>255===e))throw new Error("錯誤的裝置型號");return{updatedCnt:r.body.getUint32(0),version:(new TextDecoder).decode(r.buffer.slice(8))}},async bleUploadFirmwareStep1(e,t,r){if(!_.inRange(e,0,256))throw new Error("ackFreq 必須介於 0x1 和 0xff 之間");if(!_.inRange(t,4,16384))throw new Error("blockSize 必須介於 0x4 和 0x3fff 之間");if(!_.inRange(r,0,4294967296))throw new Error("blockCnt 有誤");const i=this.bleNewRequest({cmd:241,len:8}),n=(i.body.setUint8(0,1),i.body.setUint8(1,e),i.body.setUint16(2,t),i.body.setUint32(4,r),await this.bleSendRequest({req:i,timeout:22e3}));var a={code:_.padStart(n.body.getUint16(0).toString(16),4,"0"),ackFreq:n.body.getUint8(2),blockSize:n.body.getUint16(3),blockCnt:n.body.getUint32(5)};if("0001"!==a.code)throw new Error(ERRCODE[a.code]||"未知錯誤 "+a.code);if(e!==a.ackFreq)throw new Error("ackFreq 設定失敗");if(t!==a.blockSize)throw new Error("blockSize 設定失敗");if(r!==a.blockCnt)throw new Error("blockCnt 設定失敗");return a},bleUploadFirmwareStep2:(()=>{const o={};return async function(e,t,r,i){if(!(e instanceof ArrayBuffer))throw new Error("file 的型態有誤");if(!_.isSafeInteger(t)||t<0)throw new Error("file 的 start 有誤");if(!_.isSafeInteger(r)||r<1)throw new Error("file 的 len 有誤");if(t+r>e.byteLength)throw new Error("start + len 超過 file 的大小");var n="reqs."+(i?"y":"n")+r,n=(_.get(o,n)||_.set(o,n,this.bleNewRequest({ack:i,cmd:242,len:r})),_.get(o,n));new Uint8Array(n.buffer,4).set(new Uint8Array(e,t,r));const a=await this.bleSendRequest({req:n});if(i){e={code:_.padStart(a.body.getUint16(0).toString(16),4,"0"),crc:a.body.getUint8(2)};if("0001"!==e.code)throw new Error(ERRCODE[e.code]||"未知錯誤 "+e.code);return e}}})(),async bleUploadFirmwareStep3(){var e=this.bleNewRequest({cmd:243});const t=await this.bleSendRequest({req:e});e={code:_.padStart(t.body.getUint16(0).toString(16),4,"0")};if("0001"!==e.code)throw new Error(ERRCODE[e.code]||"未知錯誤 "+e.code);return e},async getBluetoothAvailability(){return _.invoke(navigator,"bluetooth.getAvailability")},async bleSearchDevice(){if(!this.device){if(!await this.getBluetoothAvailability())throw new Error("您的裝置不支援藍芽功能");if(this.device=await navigator.bluetooth.requestDevice({filters:[{services:[this.h.uuidService]}]}),!this.device)throw new Error("未選擇裝置");this.logTime("裝置選擇成功")}},async bleEnsureConnected(){var t=()=>_.get(this,"device.gatt.connected");if(!t()){var{uuidService:e,uuidWrite:r,uuidNotify:i}=this.h;await this.bleSearchDevice();for(let e=0;!t()&&e<3;e++)try{this.logTime(`嘗試連線至裝置 (第 ${e+1} 次)`),await this.device.gatt.connect(),await sleep(500)}catch(e){console.error("device.gatt.connect() = "+JSON.stringify(window.errToPlainObj(e)))}if(!t())throw new Error("裝置連線失敗");this.device.addEventListener("gattserverdisconnected",this.bleOnDisconnect),this.bleService=await this.device.gatt.getPrimaryService(e),this.bleCharWrite=await this.bleService.getCharacteristic(r),this.bleCharNotify=await this.bleService.getCharacteristic(i),this.bleCharNotify.addEventListener("characteristicvaluechanged",this.bleOnNotify),await this.bleCharNotify.startNotifications(),this.logTime("裝置連線成功")}},async bleDisconnect(){this.device&&(this.device.gatt.disconnect(),this.device=null)},async bleOnDisconnect(){this.logTime("裝置斷線"),this.bleCharNotify&&(this.bleCharNotify.removeEventListener("characteristicvaluechanged",this.bleOnNotify),this.bleCharNotify=null),this.bleCharWrite&&(this.bleCharWrite=null),this.bleService&&(this.bleService=null),this.device&&(this.device.removeEventListener("gattserverdisconnected",this.bleOnDisconnect),_.get(this,"device.gatt.connected")&&this.device.gatt.disconnect())},async bleOnNotify(e){var t="pending.bleSendRequest";const r={buffer:_.get(e,"target.value.buffer")};this.logTime("收到回應 "+this.inspectBuffer(r.buffer));try{r.body=new DataView(r.buffer,4),r.header=new DataView(r.buffer,0,4),r.len=16383&r.header.getUint16(1,!0);var i=r.header.getUint8(0);if(8!==i)throw new Error("錯誤的 SOF: "+i);if(r.len!==r.body.byteLength)throw new Error(`回傳資料長度有誤: len = ${r.len}, body.length = `+r.body.byteLength);_.invoke(window,t+".resolve",r)}catch(e){e.response=r,this.logTime(e.message),_.invoke(window,t+".reject",e)}},async bleSendRequest({req:t,timeout:e=3e3,verbose:r=!0}){if(!(_.get(t,"buffer")instanceof ArrayBuffer))throw new Error("invalid req.buffer");if(!(_.get(t,"header")instanceof DataView))throw new Error("invalid req.header");const i="pending.bleSendRequest";r&&this.logTime("正在送出指令 "+this.inspectBuffer(t.buffer)),await this.bleEnsureConnected();try{return await Promise.race([(async()=>{throw await sleep(e),new Error(`無回應 (${e}ms)`)})(),(async()=>{if(_.get(window,i))throw new Error("有其他 BLE 指令正在執行");var e=t.header.getUint16(1,!0)<32768?null:new Promise((e,t)=>_.set(window,i,{resolve:e,reject:t}));return await this.bleCharWrite.writeValue(t.buffer),e})()])}finally{_.set(window,i,null)}},inspectBuffer(e){return e=ArrayBuffer.isView(e)?e.buffer:e,_.join(_.map(new Uint8Array(e),e=>_.padStart(e.toString(16),2,"0"))," ")},logTime(e){console.log(`[${dayjs().format("HH:mm:ss.SSS")}] `+e)},showLoading(e,t){Swal.fire({title:e,text:t,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}})}}});</script></body></html>