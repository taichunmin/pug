<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>Inspect EasyCard</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,body,h1,h2,h3,h4,h5,h6{font-family:"Noto Sans TC",sans-serif}#card,#card input.form-control{letter-spacing:-1px}#card textarea.form-control{font-size:12px}#card .input-group-prepend .input-group-text{letter-spacing:-2px;min-width:80px}</style></head><body><div class="container-fluid my-3" id="app" v-cloak><h2 class="text-center mb-3">Inspect EasyCard</h2><div class="d-flex flex-column flex-md-row text-monospace" id="card"><div class="mr-sm-3"><div class="form-group"><label>產生轉乘交易</label><div class="mx-n1 row"><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">轉乘時間</span></div><input class="form-control" v-model="h.xferTime"><div class="input-group-append"><button class="btn btn-outline-secondary rounded-right" type="button" data-toggle="dropdown"><i class="fa fa-chevron-down"></i></button><div class="dropdown-menu dropdown-menu-right"><button class="dropdown-item" type="button" @click="btnSetXferTimeBeforeNow(10)">距今 10 分鐘前</button><button class="dropdown-item" type="button" @click="btnSetXferTimeBeforeNow(82)">距今 82 分鐘前</button></div></div></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">扣款金額</span></div><input class="form-control" type="number" v-model.number="h.xferCost"></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">轉乘群組</span></div><select class="form-control" v-model="h.xferGroup"><option :value="pair[0]" v-for="pair of _.sortBy(_.toPairs(ecc?.xferGroups), 0)">0x{{ pair[0] }}: {{ pair[1] }}</option></select></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><button class="btn btn-block btn-primary btn-sm" type="button" @click="btnMakeTxnWithXfer">複製 EML</button></div></div></div><div class="form-group"><label>卡片基本資料</label><div class="mx-n1 row"><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">卡片編號</span></div><input class="form-control" :value="card?.uid" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">餘額</span></div><input class="form-control" :value="card?.ev" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">預設加值</span></div><input class="form-control" :value="card?.autoload" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">加值銀行</span></div><input class="form-control" :value="card?.bank" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">每日限額</span></div><input class="form-control" :value="card?.quotaDaily" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">單次限額</span></div><input class="form-control" :value="card?.quotaOnce" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">限額日期</span></div><input class="form-control" :value="card?.quotaDate" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">已用限額</span></div><input class="form-control" :value="card?.quotaUsed" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">卡別</span></div><input class="form-control" :value="card?.type" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">身份別</span></div><input class="form-control" :value="card?.profileType" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">身份到期</span></div><input class="form-control" :value="card?.profileExp" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">地區</span></div><input class="form-control" :value="card?.area" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">地區身份</span></div><input class="form-control" :value="card?.areaProfile" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">發卡時間</span></div><input class="form-control" :value="card?.issued" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">卡片效期</span></div><input class="form-control" :value="card?.exp" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">月票到期日</span></div><input class="form-control" :value="card?.monthlyExp" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">社福日期</span></div><input class="form-control" :value="card?.welfareDate" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">社福點數</span></div><input class="form-control" :value="card?.welfareUsed" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">票卡狀態</span></div><input class="form-control" :value="card?.usageControl" readonly></div></div></div></div><div class="form-group"><label>轉乘紀錄</label><div class="mx-n1 row"><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">交易序號</span></div><input class="form-control" :value="card?.xfer?.tsqn" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">時間</span></div><input class="form-control" :value="card?.xfer?.time" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">交易類別</span></div><input class="form-control" :value="card?.xfer?.type" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">扣款</span></div><input class="form-control" :value="card?.xfer?.amount" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">餘額</span></div><input class="form-control" :value="card?.xfer?.ev" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">轉乘前群組</span></div><input class="form-control" :value="card?.xfer?.before" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">轉乘後群組</span></div><input class="form-control" :value="card?.xfer?.after" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">轉乘代碼</span></div><input class="form-control" :value="card?.xfer?.group" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">地點</span></div><input class="form-control" :value="card?.xfer?.location" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">設備編號</span></div><input class="form-control" :value="card?.xfer?.device" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">DFU</span></div><input class="form-control" :value="card?.xfer?.dfu" readonly></div></div></div></div><div class="form-group" v-for="txn of [card?.credit]"><label>最近加值交易</label><div class="mx-n1 row"><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">交易序號</span></div><input class="form-control" :value="txn?.tsqn" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">時間</span></div><input class="form-control" :value="txn?.time" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">交易類別</span></div><input class="form-control" :value="txn?.type" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">加值金額</span></div><input class="form-control" :value="txn?.amount" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">餘額</span></div><input class="form-control" :value="txn?.ev" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">業者</span></div><input class="form-control" :value="txn?.provider" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">地點</span></div><input class="form-control" :value="txn?.location" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">設備編號</span></div><input class="form-control" :value="txn?.device" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">RFU</span></div><input class="form-control" :value="txn?.rfu" readonly></div></div></div></div><div class="form-group"><label>最近扣款交易</label><div class="table-responsive"><table class="text-center table table-bordered table-sm table-striped"><thead><tr class="text-nowrap"><th>#</th><th>時間</th><th>類別</th><th>扣款</th><th>餘額</th><th>業者</th><th>地點</th><th>設備</th><th>RFU</th></tr></thead><tbody><tr v-for="txn of card?.deducts"><th>{{ txn?.tsqn }}</th><td>{{ txn?.time }}</td><td>{{ txn?.type }}</td><td>{{ txn?.amount }}</td><td>{{ txn?.ev }}</td><td>{{ txn?.provider }}</td><td>{{ txn?.location }}</td><td>{{ txn?.device }}</td><td>{{ txn?.rfu }}</td></tr></tbody></table></div></div><div class="form-group"><label>公車紀錄</label><div class="mx-n1 row"><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">操作員編號</span></div><input class="form-control" :value="card?.bus?.agent" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">路線編號</span></div><input class="form-control" :value="card?.bus?.line" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">時間</span></div><input class="form-control" :value="card?.bus?.time" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">站牌編號</span></div><input class="form-control" :value="card?.bus?.station" readonly></div></div><div class="col-12 col-md-6 mb-1 px-1 col-lg-4 col-xl-3"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">區段編號</span></div><input class="form-control" :value="card?.bus?.zone" readonly></div></div></div></div><div class="form-group"><label>進出站紀錄</label><div class="table-responsive"><table class="text-center table table-bordered table-sm table-striped"><thead><tr class="text-nowrap"><th>時間</th><th>進出站</th><th>業者</th><th>地點</th><th>累計次數</th><th>累計金額</th></tr></thead><tbody><tr v-for="inout of card?.inouts"><td>{{ inout?.time }}</td><td>{{ inout?.type }}</td><td>{{ inout?.provider }}</td><td>{{ inout?.location }}</td><td>{{ inout?.count }}</td><td>{{ inout?.amount }}</td></tr></tbody></table></div></div><div class="form-group"><label>Mifare 卡片金鑰</label><div class="mx-n1 row"><div class="col-12 col-md-6 mb-1 px-1"><div class="input-group input-group-sm" @click="btnCopy(card?.keya)"><div class="input-group-prepend"><span class="input-group-text justify-content-center">keyA</span></div><textarea class="form-control" rows="16" :value="card?.keya" readonly></textarea></div></div><div class="col-12 col-md-6 mb-1 px-1"><div class="input-group input-group-sm" @click="btnCopy(card?.keyb)"><div class="input-group-prepend"><span class="input-group-text justify-content-center">keyB</span></div><textarea class="form-control" rows="16" :value="card?.keyb" readonly></textarea></div></div></div></div></div><div class="form-group" style="min-width:260px"><label>EML (HEX)</label><textarea class="form-control form-control-sm" rows="65" v-model="h.eml"></textarea></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://taichunmin.idv.tw/proxmark3.js/proxmark3.min.js" crossorigin="anonymous"></script><script>const Packet=window.Proxmark3["Packet"],URL_GIST=(Packet.prototype.getFatNo=function(t){t=this.getUint24(t,!1);return(130560&t)>>9|(510&t)<<7|(1&t)<<16},Packet.prototype.setFatNo=function(t,e){this.setUint24(t,(65536&e)>>16|(65280&e)>>7|(255&e)<<9,!1)},Packet.prototype.getUnixStr=function(t){return dayjs.unix(this.getUint32(t)-28800).format("YYYY-MM-DD HH:mm:ss")},Packet.prototype.getDosDateStr=function(t){t=this.getUint16(t);return t?dayjs(1980+(t>>9)+`-${t>>5&15}-`+(31&t)).format("YYYY-MM-DD"):"無資料"},"https://gist.githubusercontent.com/taichunmin/f4699905e583354b2cbd1a6e67484235/raw");class Easycard{constructor(t){if(!(t instanceof Packet)||1024!==t.byteLength)throw new TypeError("invalid pack");this.pack=t;t=_.maxBy([384,400],t=>this.pack.getFatNo(t+12));this.fatblk=this.pack.subarray(t,t+16),this.isStale=_.flatten(_.times(8,e=>_.times(8,t=>this.fatblk[e]&128>>t?1:0))),this.bus=this.getBus(),this.credit=this.getTxn(160),this.inouts=this.getInouts(),this.tsqnblk=this.getFreshBlk(12,26),this.xferblk=this.getFreshBlk(13,14),this.deducts=_.chain([16,17,18,20,21,22]).map(t=>this.getTxn(t<<4)).sortBy(["time"]).value()}static fromEml(t){t=Packet.fromHex(t.replace(/-/g,"0"));if(1024!==t.byteLength)throw new TypeError("錯誤的 eml");return new Easycard(t)}makeTxnWithXfer({cost:t=0,time:e,group:a=0}){const r=this.pack.slice(),s={},n={},i=t=>r.subarray(t,t+16);[n.fat,s.fat]=_.map(_.sortBy([384,400],t=>r.getFatNo(t+12)),i),s.stale=_.flatten(_.times(8,e=>_.times(8,t=>s.fat[e]&128>>t?1:0))),n.stale=s.stale.slice(),[s.tsqn,n.tsqn]=_.map(_.sortBy([12,26],t=>s.stale[t]),t=>i(t<<4)),[s.xfer,n.xfer]=_.map(_.sortBy([13,14],t=>s.stale[t]),t=>i(t<<4));var o=t=>{let e=s.tsqn[1]<<8|r[t];return e>s.tsqn.getUint16(0)&&(e-=256),4294967296*e+r.getUint32(t+1)};s.txn=i(_.maxBy([160,256,272,288,320,336,352],o)),n.txn=i(_.minBy([256,272,288,320,336,352],o)),r.setInt32(128,r.getInt32(128)-t);for(const h of[136,144,152])r.setInt32(h,r.getInt32(128));for(const g of[132,148])r.setInt32(g,~r.getInt32(128));var c;n.tsqn.setUint16(0,s.tsqn.getUint16(0)+1),n.tsqn[2]=(o=e,c=s.txn.getUint32(1),(_.floor(o/86400)===_.floor(c/86400)?s.tsqn[2]:0)+1),n.tsqn.set(s.tsqn.subarray(3,16),3);for(const u of[12,26])n.stale[u]=1-n.stale[u];if(n.txn[0]=n.tsqn[0],n.txn.setUint32(1,e),n.txn[5]=32,n.txn.setUint16(6,t),n.txn.set(r.subarray(128,130),8),n.txn.set(Packet.fromHex("600103306000"),10),0<a){n.tsqn[12]=15==(15&s.xfer[10])?s.tsqn[13]:15&s.xfer[10],n.tsqn[13]=a,n.xfer[0]=n.tsqn[0],n.xfer.set(n.txn.subarray(1,16),1),n.xfer[10]=_.clamp(n.tsqn[12],15)<<4|_.clamp(n.tsqn[13],15);for(const p of[13,14])n.stale[p]=1-n.stale[p]}n.fat.set(s.fat);for(let e=0;e<8;e++)for(let t=n.fat[e]=0;t<8;t++)n.fat[e]|=n.stale[8*e+t]?128>>t:0;n.fat.setFatNo(12,n.fat.getFatNo(12)+1),n.fat[15]=0;for(const l of n.fat.subarray(0,15))n.fat[15]^=l;return new Easycard(r)}getFreshBlk(t,e){e=(this.isStale[t]?e:t)<<4;return this.pack.subarray(e,16+e)}getTxn(t){const e=this.pack;return{...this.getSploc(t+10),tsqn:"0x"+e.subarray(t,t+1).hex,tsqnUint:e.getUint8(t),time:this.pack.getUnixStr(t+1),type:this.getTxnType(t+5),amount:e.getInt16(t+6),ev:e.getInt16(t+8),device:"0x"+e.subarray(t+12,t+15).rhex,rfu:"0x"+e.subarray(t+15,t+16).hex}}getBus(){const t=this.getFreshBlk(45,46);return{agent:"0x"+t.subarray(3,5).rhex,line:"0x"+t.subarray(5,7).hex,time:t.getUnixStr(7),station:t.getUint8(11),zone:t.getUint8(12)}}getInouts(){var t,e,a=_.compact([this.getFreshBlk(29,30),this.getFreshBlk(49,50)]),r=window.EasycardData?.sploc??{},s={0:r[2],100:r[100],103:r[103],105:r[105],107:r[107],200:r[200]};const n=[];for(const i of a)i.getUint32(9)&&([t,e]=[i.getUint8(15),i.getUint8(4)],n.push({provider:t+": "+(s[t]?.[e]?.provider??"未知"),location:e+": "+(s[t]?.[e]?.location??"未知"),amount:i.getUint16(6,!1),count:i.getUint8(5),time:i.getUnixStr(9),type:"出進"[i.getUint8(3)]+"站"}));return _.sortBy(n,["time"])}getSploc(t){var e=this.pack,a=_.get(window,["EasycardData","sploc"],[]),[e,t]=[e[t],e[t+1]],a=a[e]?.[t]??a?.[e]?.[0]??{};return{provider:e+": "+(a.provider??"未知"),location:t+": "+(a.location??"未知")}}getNameU8(t,e){var a=window.EasycardData??{},e=this.pack.subarray(e,e+1).hex;return`0x${e}: `+_.get(a,[t,e],"未知")}getTxnType(t){return this.getNameU8("txnTypes",t)}get usageControl(){const a=this.pack.getUint8(24)|this.tsqnblk.getUint8(7);return _.filter(["已啟用","被封鎖","已退卡","自動加值","Credit"],(t,e)=>a>>e&1).join()}get keya(){const e=this.pack;return _.uniq(_.times(16,t=>e.subarray(48+(t<<6),54+(t<<6)).hex)).join("\n")}get keyb(){const e=this.pack;return _.uniq(_.times(16,t=>e.subarray(58+(t<<6),64+(t<<6)).hex)).join("\n")}get eml(){const e=this.pack;return _.times(64,t=>e.subarray(t<<4,t+1<<4).hex).join("\n")}get xfer(){const{tsqnblk:a,xferblk:r}=this;var t=t=>{let e="0"+r.subarray(10,11).hex[t];"0F"===e&&(e=a.subarray(t+12,t+13).hex);t=window.EasycardData?.xferGroups?.[e];return t?`0x${e}: `+t:"0x"+e},e=window.EasycardData?.sploc??{},e={1:e[2],7:e[200],8:e[100],10:e[102],11:e[103],20:e[107],22:e[105]};let s=15&r.getUint8(10);return 15===s&&(s=a.getUint8(13)),{tsqn:`0x${a.subarray(0,2).rhex} (${a.getUint16(0)})`,before:t(0),after:t(1),time:r.getUnixStr(1),type:this.getTxnType(r.byteOffset+5),amount:r.getInt16(6),ev:r.getInt16(8),group:`0x${r.subarray(10,11).hex}, 0x`+a.subarray(12,14).hex,location:`0x${r.subarray(11,12).hex}: `+(e[s]?.[r.getUint8(11)]?.location??"未知"),device:"0x"+r.subarray(12,15).rhex,dfu:"0x"+r.subarray(15,16).hex}}get areaProfile(){var[t,e]=_.map([90,92],t=>this.pack[t]);const a=[];return 3===t&&1&e&&a.push("基隆學生"),6===t&&(2&e&&a.push("連江軍警"),a.push("連江"+["南竿","北竿","東引","莒光"][e>>2&3])),16&e&&a.push("限制通路"),8===t&&a.push("新竹市"+["市民卡","認同卡","榮譽市民卡"][e>>5&3]),10===t&&a.push("台中"+["市民","原住民"][e>>5&3]),21===t&&a.push("苗栗"+["市民","原住民"][e>>5&3]),1===t&&a.push("台北"+["市民","65歳以上愛心"][e>>5&3]),a.join(",")}get area(){return this.getNameU8("areaCodes",90)}get autoload(){return this.pack.getUint16(81)}get bank(){return this.getNameU8("bankCodes",91)}get welfareDate(){return this.tsqnblk.getDosDateStr(5)}get welfareUsed(){return`已用${this.tsqnblk.getUint16(3)}點`}get ev(){return this.pack.getInt32(128)}get exp(){return this.pack.getUnixStr(73)}get issued(){return this.pack.getUnixStr(69)}get monthlyExp(){return this.tsqnblk.getDosDateStr(14)}get profileExp(){return this.pack.getDosDateStr(88)}get profileType(){return this.getNameU8("profiles",87)}get quotaDaily(){return this.pack.getUint16(83)}get quotaDate(){return this.pack.getDosDateStr(1003)}get quotaOnce(){return this.pack.getUint16(85)}get quotaUsed(){return this.pack.getUint16(1005)}get type(){return this.getNameU8("cardTypes",93)}get uid(){return this.pack.getUint32(0)}}window.vm=new Vue({el:"#app",data:{ready:!1,ecc:null,h:{eml:"",xferGroup:"00",xferCost:0,xferTime:""}},async mounted(){try{var t=JSON5.parse(localStorage.getItem(location.pathname));t&&this.$set(this,"h",{...this.h,...t})}catch(t){}this.$watch("h",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.h))},{deep:!0}),await this.init()},computed:{card(){try{return this.ready?Easycard.fromEml(this.h.eml):void 0}catch(t){console.error(t)}}},methods:{async init(){try{await Promise.all([this.initSploc(),this.initMappingJson5()]),this.ready=!0}catch(t){console.error(t),Swal.fire({icon:"error",title:"發生錯誤",text:t.message})}},async initSploc(){var t=await this.getCsv(URL_GIST+"/sp_loc_mapping.csv");_.set(window,"EasycardData.sploc",{});const e=window.EasycardData.sploc;for(const a of t)e[a.spId]||(e[a.spId]={}),e[a.spId][a.locId]={provider:_.trim(a.spName),location:_.trim(a.locName)}},async initMappingJson5(t=3e4){t=JSON5.parse(_.get(await axios.get(URL_GIST+"/mapping.json5",{params:{cachebust:_.floor(Date.now()/t)}}),"data"));window.EasycardData||(window.EasycardData={});const a=window.EasycardData;_.each(t,(t,e)=>_.set(a,e,_.fromPairs(t))),this.$set(this,"ecc",a)},async getCsv(t,e=3e4){t=_.trim(_.get(await axios.get(t,{params:{cachebust:_.floor(Date.now()/e)}}),"data"));return _.get(Papa.parse(t,{encoding:"utf8",header:!0}),"data",[])},async btnCopy(t,e=null){e=e||document.body;const a=document.createElement("textarea");a.value=t,e.appendChild(a),a.select(),a.setSelectionRange(0,1e6),document.execCommand("copy"),e.removeChild(a),await Swal.fire({icon:"success",title:"複製成功"})},async btnMakeTxnWithXfer(){try{if(!/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(this.h.xferTime))throw new TypeError("invalid time");if(this.h.xferCost<0)throw new TypeError("invalid cost");var t=await this.card.makeTxnWithXfer({cost:this.h.xferCost??0,time:dayjs(this.h.xferTime).unix()+28800,group:_.parseInt(this.h.xferGroup,16)});await this.btnCopy(t.eml)}catch(t){console.error(t),await Swal.fire({icon:"error",title:"發生錯誤",text:t.message})}},btnSetXferTimeBeforeNow(t){this.$set(this.h,"xferTime",dayjs().subtract(t,"minute").format("YYYY-MM-DD HH:mm:ss"))}}});</script></body></html>