<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>LINE 訊息推送工具</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><meta content="2133031763635285" property="fb:app_id"><meta content="LINE Notify 大量發送工具" property="og:description"><meta content="zh_TW" property="og:locale"><meta content="筆記國度" property="og:site_name"><meta content="LINE 訊息推送工具" property="og:title"><meta content="website" property="og:type"><meta content="https://liff.line.me/1654046335-GrzoBW0r" property="og:url"><style>[v-cloak]{display:none}.h-400px{height:400px!important}#error{position:fixed;bottom:0;z-index:1071;left:1rem;right:1rem}#error button.close{position:absolute;right:1.25rem;top:.75rem}</style></head><body><div class="container my-3 text-monospace" id="app" v-show="ready" v-cloak><div class="alert alert-danger" id="error" v-show="error" role="alert"><pre class="mb-0">{{ `${error}\n請於開發者工具中查看詳細錯誤內容` }}</pre><button class="close" @click="error = ''" type="button"><span>×</span></button></div><h1>LINE 訊息推送工具</h1><div class="form-group"><label for="csv">CSV 網址 (資料會放到 <code>row</code> 然後以第一列當作 key)</label><textarea class="form-control form-control-sm" id="csv" v-model="i.csv" rows="5"></textarea></div><div class="row"><div class="col"><div class="form-group"><label for="to">傳送給 (範例：<code>${row.line_id}</code>)</label><input class="form-control form-control-sm" id="to" v-model="i.to"></div></div><div class="col"><div class="form-group"><label for="access-token">Access Token</label><input class="form-control form-control-sm" id="access-token" v-model="i.accessToken" type="password"></div></div></div><div class="form-group"><label for="msg">訊息內容 JSON (先處理變數才會轉 JSON，務必注意 JSON escape 的問題)</label><textarea class="form-control form-control-sm h-400px" id="msg" v-model="i.msg"></textarea></div><div class="row mx-n2"><button class="btn mx-2 my-1 btn-success" @click="lineShare" type="button">分享測試訊息</button><button class="btn mx-2 my-1 btn-light" disabled v-if="status">{{ status }}…</button><button class="btn mx-2 my-1 btn-danger" @click="linePush" type="button" v-else>推送訊息</button><a class="btn mx-2 my-1 btn-outline-info" href="https://taichunmin.idv.tw/blog/2020-06-15-line-push-template.html" target="_blank">使用教學</a><a class="btn mx-2 my-1 btn-outline-info" href="https://developers.line.biz/flex-simulator/" target="_blank">Flex 訊息模擬器</a><a class="btn mx-2 my-1 btn-outline-info" href="https://developers.line.biz/en/reference/messaging-api/#flex-message" target="_blank">LINE 訊息文件</a><a class="btn mx-2 my-1 btn-outline-info" href="https://lodash.com/docs/#template" target="_blank">_.template 變數語法說明</a></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://static.line-scdn.net/liff/edge/2/sdk.js" crossorigin="anonymous"></script><script>window.loginPromise=(async()=>{await liff.init({liffId:"1654046335-GrzoBW0r"}),new URL(window.location).searchParams.get("liff.state")&&await new Promise(e=>{}),liff.isLoggedIn()||(liff.login({redirectUri:location.href}),await new Promise(e=>{}));try{return await liff.getProfile()}catch(e){}})(),window.sleep=s=>new Promise(e=>setTimeout(e,s)),window.vm=new Vue({el:"#app",data:{error:"",ready:!1,status:"",i:{accessToken:"",csv:"",msg:"",to:"${row.line_id}"}},async mounted(){try{var e=JSON5.parse(localStorage.getItem(location.pathname));e&&this.$set(this,"i",{...this.i,...e})}catch(e){}this.$watch("i",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.i))},{deep:!0}),this.ready=!0},methods:{async linePush(){const t=[];try{this.status="正在從 csv 取得資料";var e=await this.getCsv(this.i.csv);if(console.log(`成功從 csv 中取得 ${e.length} 筆資料`),e.length<=0)throw new Error("csv 中沒有任何記錄");if(this.status="等候使用者確認推送",await sleep(100),!confirm(`即將推送 ${e.length} 則訊息！`))throw new Error("使用者自行取消推送");this.status="正在解析訊息內容 JSON";const r=_.template(this.i.to),o=_.template(this.i.msg);let s=0;for(const n of e)try{this.status=`正在傳送訊息 (${++s} / ${e.length})`;var a=r({Qs:Qs,_:_,dayjs:dayjs,row:n}),i=JSON5.parse(o({Qs:Qs,_:_,dayjs:dayjs,row:n}));await this.pushMessage(a,i)}catch(e){e.message=`第 ${s} 筆發生錯誤: `+e.message,console.error(e),t.push(e)}}catch(e){console.error(e),t.push(e)}this.error=_.map(t,e=>e.message).join("\n"),this.status=""},async lineShare(){try{if(await loginPromise,!liff.isApiAvailable("shareTargetPicker"))throw new Error("不支援 shareTargetPicker，請嘗試更新應用程式版本。");var s=await this.getCsv(this.i.csv);if(s.length<1)throw new Error("無法從 csv 中取得資料");const a=_.template(this.i.msg);let e=JSON5.parse(a({Qs:Qs,_:_,dayjs:dayjs,row:_.first(s)}));_.includes(["bubble","carousel"],_.get(e,"type"))&&(e={type:"flex",altText:"您有一則新訊息",contents:e}),console.log("messages =",JSON.stringify(e));var t=await liff.shareTargetPicker(_.isArray(e)?e:[e]);if("success"!==_.get(t,"status"))throw new Error("傳送失敗");await Swal.fire({icon:"success",title:"測試訊息已分享"})}catch(e){console.error(e),this.error=e.message}},async getCsv(e,s=3e4){e=_.trim(_.get(await axios.get(e,{params:{cachebust:_.floor(Date.now()/s)}}),"data"));return _.get(Papa.parse(e,{encoding:"utf8",header:!0}),"data",[])},async pushMessage(s,t,a=!1){try{if(!this.isLineId(s))throw new Error(`不正確的 LINE userId: "${s}"`);if(!/^[A-Za-z0-9+/=]+$/.test(this.i.accessToken))throw new Error(`不正確的 Access Token: "${this.i.accessToken}"`);_.includes(["bubble","carousel"],_.get(t,"type"))&&(t={type:"flex",altText:"您有一則新訊息",contents:t}),_.isArray(t)||(t=[t]),await axios.post("https://cors-anywhere-ybtjbo45iq-uc.a.run.app",{to:s,messages:t,notificationDisabled:a},{params:{u:"https://api.line.me/v2/bot/message/push"},headers:{Authorization:"Bearer "+this.i.accessToken}})}catch(e){throw _.hasIn(e,"response")&&(s={status:(a=e.response).status,headers:a.headers,data:a.data,to:s,messages:t},console.log(s),e.stack=`${e.name}: LINE pushMessage failed with status code ${a.status}
`+JSON.stringify(s,null,2)),e}},isLineId(e){return"Udeadbeefdeadbeefdeadbeefdeadbeef"!==e&&/^U[0-9a-f]{32}$/.test(e)}}});</script></body></html>