<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>微程式課程簽到 QR 碼</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}#qrcode svg{width:300px}</style></head><body><div class="container text-monospace" id="app" v-cloak><h2 class="my-2 text-center">微程式課程簽到 QR 碼</h2><div id="not-signin" v-if="!idToken"><button class="btn btn-block btn-primary" type="button" @click="signin"><span class="fa fa-google"></span> 請用微程式 Google 帳戶登入</button></div><div id="signin" v-else><div class="text-center my-4" id="qrcode" v-if="!loading && qrSvg"><a :href="url" target="_blank" v-html="qrSvg"></a></div><button class="my-2 btn btn-block btn-primary" type="button" disabled v-if="loading"><span class="spinner-border spinner-border-sm" role="status"></span> 正在產生第 {{ cnt + 1 }} 個</button><button class="my-2 btn btn-block btn-primary" type="button" @click="btnNext" v-else>產生第 {{ cnt + 1 }} 個</button><div class="my-2 input-group"><div class="input-group-prepend"><div class="input-group-text">名稱</div></div><input class="form-control" v-model="i.name"></div><div class="my-2 input-group"><div class="input-group-prepend"><div class="input-group-text">點數</div></div><input class="form-control" type="number" v-model.number="i.score"></div><div class="my-2 input-group"><div class="input-group-prepend"><div class="input-group-text">網址</div></div><input class="form-control" type="url" v-model="i.url"></div><div class="my-2 input-group"><div class="input-group-prepend"><div class="input-group-text">圖片</div></div><input class="form-control" type="url" v-model="i.image"></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/crypto-js@4/crypto-js.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qrcode@1/build/qrcode.min.js" crossorigin="anonymous"></script><script>const SPREADSHEET_ID="1dJhB5_auh5Fzqy7VfUnmFPpiT7OYF5BvpZ6nmrV9RJo",GAPI_INIT_ARGS="eyJhcGlLZXkiOiJBSXphU3lCc1A0ekhCWnREU2NKMV81b3FZZlM1OWZiTnNPXzN4V0UiLCJjbGllbnRJZCI6IjQxNzk1NDIwMjc0Ny02MmEwcG4yYW5rcnNjbzc5MGpyMWgyOW45dm5mOTJsbS5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSJ9";let sheetsAPI=null;const textToQrSvg=(()=>{const t={margin:0};return e=>QRCode.toString(e,t)})(),vm=new Vue({el:"#app",data:{cnt:0,course:"",idToken:null,loading:!1,qrSvg:"",secret:"",i:{image:"",name:"",score:0,url:""}},async mounted(){try{var e=JSON5.parse(localStorage.getItem(location.pathname));e&&this.$set(this,"i",{...this.i,...e})}catch(e){}this.$watch("i",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.i))},{deep:!0})},watch:{async url(e){e&&(this.qrSvg=await textToQrSvg(e))}},computed:{url(){if(!this.course||!this.secret)return"";var e=this.atob(JSON.stringify({alg:"HS256",typ:"JWT"})),t=this.atob(JSON.stringify(this.course)),a=this.atob(CryptoJS.HmacSHA256(e+"."+t,this.secret));const s=new URL("https://taichunmin.idv.tw/pug/microprogram-course.html");return s.searchParams.set("c",e+`.${t}.`+a),s.href}},methods:{async gapiOnInit(){try{await new Promise(e=>{gapi.load("client:auth2",e)}),await gapi.client.init({discoveryDocs:["https://sheets.googleapis.com/$discovery/rest?version=v4"],scope:"profile email https://www.googleapis.com/auth/spreadsheets",...JSON.parse(this.btoa(GAPI_INIT_ARGS))});const a=gapi.auth2.getAuthInstance();await new Promise(t=>{var e=e=>{e&&t()};a.isSignedIn.listen(e),e(a.isSignedIn.get())}),sheetsAPI=gapi.client.sheets.spreadsheets,this.idToken=a.currentUser.get().getAuthResponse().id_token,this.secret=await this.sheetGetJwtSecret()}catch(e){console.log(e),Swal.fire({icon:"error",title:"取得加密金鑰失敗",text:e.message})}},signin(){gapi.auth2.getAuthInstance().signIn()},atob(e){return _.isString(e)&&(e=CryptoJS.enc.Utf8.parse(e)),CryptoJS.enc.Base64.stringify(e).replaceAll(/[+/=]/g,e=>_.get({"+":"-","/":"_"},e,""))},btoa(e){return e=e.replaceAll(/[-_]/g,e=>_.get({"-":"+",_:"/"},e,"")),CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Base64.parse(e))},randomBase64(e){return this.atob(CryptoJS.lib.WordArray.random(e))},async btnNext(){try{this.loading=!0;var e=moment().format("YYYY-MM-DD HH:mm:ss"),t=["",this.i.name,this.i.score,e,""],a=_.get(await this.sheetAppend("attended!A:E",t),"updates.updatedRange"),s=this.randomBase64(9);await this.sheetSetRowMetadata(a,"nonce",s),this.course={image:this.i.image,name:this.i.name,nonce:s,score:this.i.score,url:this.i.url},this.cnt++}catch(e){console.log(e),Swal.fire({icon:"error",title:"產生 QR 碼失敗",text:e.message})}this.loading=!1},async sheetAppend(e,t){e=await sheetsAPI.values.append({spreadsheetId:SPREADSHEET_ID,range:e,valueInputOption:"RAW",insertDataOption:"INSERT_ROWS",responseValueRenderOption:"FORMATTED_VALUE",responseDateTimeRenderOption:"FORMATTED_STRING",fields:"updates"},{range:e,majorDimension:"ROWS",values:[t]});return console.log(e.result),e.result},async sheetRowToLocation(e){var e=await sheetsAPI.get({spreadsheetId:SPREADSHEET_ID,includeGridData:!1,ranges:[e],fields:"sheets(data.startRow,properties.sheetId)"}),t=(console.log(e.result),_.get(e,"result.sheets.0.data.0.startRow"));return{dimensionRange:{sheetId:_.get(e,"result.sheets.0.properties.sheetId"),dimension:"ROWS",startIndex:t,endIndex:t+1}}},async sheetSetRowMetadata(e,t,a){t=await sheetsAPI.batchUpdate({spreadsheetId:SPREADSHEET_ID,fields:"replies"},_.set({},"requests.0.createDeveloperMetadata.developerMetadata",{metadataKey:t,metadataValue:a,visibility:"DOCUMENT",location:await this.sheetRowToLocation(e)}));return console.log(t.result),t.result},async sheetSetJwtSecret(e){await this.sheetDelJwtSecret();var t=await sheetsAPI.batchUpdate({spreadsheetId:SPREADSHEET_ID},_.set({},"requests.0.createDeveloperMetadata.developerMetadata",{metadataId:1,metadataKey:"jwt-secret",metadataValue:e,visibility:"DOCUMENT",location:{spreadsheet:!0}}));return console.log(t.result),e},async sheetGetJwtSecret(){try{var e=await sheetsAPI.developerMetadata.get({spreadsheetId:SPREADSHEET_ID,metadataId:1,fields:"metadataKey,metadataValue"}),{metadataKey:t,metadataValue:a}=(console.log(e.result),_.get(e,"result"));return"jwt-secret"===t?a:null}catch(e){if(404===_.get(e,"result.error.code"))return null;throw e}},async sheetDelJwtSecret(){var e=await sheetsAPI.batchUpdate({spreadsheetId:SPREADSHEET_ID},_.set({},"requests.0.deleteDeveloperMetadata.dataFilter.developerMetadataLookup",{locationType:"SPREADSHEET",metadataId:1}));console.log(e.result)},async sheetRenewJetSecret(){return this.secret=await this.sheetSetJwtSecret(this.randomBase64(48)),this.secret}}});</script><script src="https://apis.google.com/js/api.js" crossorigin="anonymous" async defer onload="this.onload=function(){},vm.gapiOnInit();" onreadystatechange='"complete"===this.readyState&&this.onload();'></script></body></html>