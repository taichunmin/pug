<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>微程式課程簽到簿</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}img.card-img{width:100px}</style></head><body><div class="container text-monospace" id="app" v-cloak><h1 class="my-3 text-center">微程式課程簽到簿</h1><div class="my-3" id="not-signin" v-if="!user"><button class="btn btn-success btn-block" type="button" @click="btnSignin"><span class="fa fa-google"></span> 請用微程式 Google 帳戶登入</button></div><div class="my-3 card border-danger" id="signin" v-else><div class="no-gutters row"><img :src="user.imageUrl" class="card-img"><div class="col"><div class="card-body"><h5 class="card-title">{{ user.name }} <small class="text-muted">{{ username }}</small></h5><p class="card-text">已累計課程點數 {{ totalScore }} 點</p></div></div></div></div><div class="my-3 card" v-if="course"><img :src="course.image" class="card-img-top" v-if="course.image"><div class="card-body"><h5 class="card-title">{{ course.name }}</h5><h6 class="text-muted card-subtitle mb-2" v-if="course.score > 0">簽到將可累計課程點數 {{ course.score }} 點</h6><button class="btn btn-success mr-2" type="button" @click="btnSignin" v-if="!user"><span class="fa fa-google"></span> 請登入簽到</button><button class="btn btn-success mr-2" type="button" disabled v-else-if="loading"><span class="spinner-border spinner-border-sm" role="status"></span> 正在簽到中</button><button class="btn btn-success mr-2" type="button" disabled v-else-if="isCheckIn">已簽到</button><button class="btn btn-success mr-2" type="button" @click="btnCheckIn" v-else>課程簽到</button><a :href="course.url" class="btn btn-outline-primary" target="_blank">相關連結</a></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/crypto-js@4/crypto-js.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vconsole@3/dist/vconsole.min.js" crossorigin="anonymous"></script><script>window.vConsole=new VConsole,window.vm=new Vue({el:"#app",data:{attends:[],idToken:null,loading:!1,user:null,i:{checkins:[]}},async mounted(){try{var e=JSON5.parse(localStorage.getItem(location.pathname));e&&this.$set(this,"i",{...this.i,...e})}catch(e){}this.$watch("i",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.i))},{deep:!0}),await this.getAttends()},computed:{totalScore(){return _.sumBy(this.attends,e=>e.id===this.user.id?_.parseInt(e.score):0)},username(){return this.user?_.get(this.user.email.split("@"),"0",""):""},c(){const e=new URL(location);return e.searchParams.get("c")},course(){try{return JSON.parse(this.btoa(this.c.split(".")[1]))}catch(e){return null}},isCheckIn(){return!!this.course&&_.includes(this.i.checkins,this.course.nonce)}},methods:{async gapiOnInit(){try{await new Promise(e=>{gapi.load("client:auth2",e)}),await gapi.client.init({clientId:"417954202747-62a0pn2ankrsco790jr1h29n9vnf92lm.apps.googleusercontent.com",scope:"profile email"});const s=gapi.auth2.getAuthInstance(),e=(await new Promise(t=>{var e=e=>{e&&t()};s.isSignedIn.listen(e),e(s.isSignedIn.get())}),s.currentUser.get()),t=e.getBasicProfile();this.$set(this,"user",{email:t.getEmail(),familyName:t.getFamilyName(),givenName:t.getGivenName(),id:t.getId(),imageUrl:t.getImageUrl(),name:t.getName()}),this.idToken=e.getAuthResponse().id_token}catch(e){console.error(e),await Swal.fire({icon:"error",title:"初始化錯誤",text:e.message})}},btnSignin(){gapi.auth2.getAuthInstance().signIn()},btnSignout(){gapi.auth2.getAuthInstance().signOut()},btoa(e){return e=e.replaceAll(/[-_]/g,e=>_.get({"-":"+",_:"/"},e,"")),CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Base64.parse(e))},async btnCheckIn(){try{this.loading=!0,await axios.post("https://us-central1-ai-country.cloudfunctions.net/microprogram-course",{c:this.c,g:this.idToken}),this.saveCheckIns(),this.attends.push({id:this.user.id,score:this.course.score}),Swal.fire({icon:"success",title:"簽到成功",text:0<this.course.score?`您已成功獲得 ${this.course.score} 點課程點數`:"感謝您參加課程"})}catch(e){console.log(e),500!==e.status&&this.saveCheckIns(),Swal.fire({icon:"error",title:"簽到失敗",text:_.get(e,"response.data.message")||e.message})}this.loading=!1},saveCheckIns(){var e=_.slice(_.uniq([...this.i.checkins,this.course.nonce]),-10);this.$set(this.i,"checkins",e)},async getCsv(e,t=3e4){e=_.trim(_.get(await axios.get(e,{params:{cachebust:_.floor(Date.now()/t)}}),"data"));return _.get(Papa.parse(e,{encoding:"utf8",header:!0}),"data",[])},async getAttends(){this.attends=await this.getCsv("https://cors-anywhere.herokuapp.com/https://docs.google.com/spreadsheets/d/e/2PACX-1vTDyD-tW4bDQ-7NILOhpBPRrskDpQZvaQw9_my-Mbd8TJ7j_xRlBxSUdYtNSfeNhF-gzALuNHia8f36/pub?gid=1069299348&single=true&output=csv")}}});</script><script src="https://apis.google.com/js/api.js" crossorigin="anonymous" async defer onload="this.onload=function(){},vm.gapiOnInit();" onreadystatechange='"complete"===this.readyState&&this.onload();'></script></body></html>