<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>MPPARKQA 車牌螢幕</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,body,h1,h2,h3,h4,h5,h6{font-family:"Noto Sans TC",sans-serif}</style></head><body><div class="container-fluid my-3 text-monospace" id="app" v-cloak><h2 class="mb-3 text-center">{{ title }}</h2><div class="align-items-center d-flex justify-content-center" @click="btnFullScreen" ref="img"><img :key="img" :src="img" class="w-100"></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/mqtt@4/dist/mqtt.min.js" crossorigin="anonymous"></script><script>window.vm=new Vue({el:"#app",data:{conn:null,device:"",img:"",title:"MPPARKQA 車牌螢幕",topicConfig:null,topicState:null},async mounted(){try{var t=JSON5.parse(localStorage.getItem(location.pathname));t&&this.$set(this,"h",{...this.h,...t})}catch(t){}this.$watch("h",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.h))},{deep:!0}),await this.init()},methods:{async init(){try{this.showLoading("請稍候","讀取資料中");var t=this.param("device");if(!t)throw new Error("device is required");this.title=`MPPARKQA 車牌螢幕 (${t})`,this.device=t;const s=this.param("host");if(!s)throw new Error("host is required");this.topicConfig=`mpparkqa/${t}/config`,this.topicState=`mpparkqa/${t}/state`,this.conn=await new Promise((t,i)=>{const e=window.mqtt.connect(s,{will:{payload:JSON.stringify({type:"plate",status:"offline"}),qos:1,retain:!0,topic:this.topicState}});e.on("connect",()=>t(e)),e.on("error",t=>i(t))}),this.conn.on("message",this.mqttOnMessage),await this.mqttSubscribe(this.topicConfig,{qos:1}),await this.mqttPublish(this.topicState,{type:"plate",status:"online"},{qos:1,retain:!0}),Swal.close()}catch(t){console.error(t),await Swal.fire({icon:"error",title:"發生錯誤",text:t.message}),location.reload()}},async mqttSubscribe(t,i){if(_.isString(t))return new Promise((e,s)=>{this.conn.subscribe(t,i,(t,i)=>t?s(t):e(i))});throw new Error("topic is required")},async mqttPublish(t,s,o){if(_.isString(t))return _.isString(s)||(s=JSON.stringify(s)),new Promise((i,e)=>{this.conn.publish(t,s,o,t=>t?e(t):i())});throw new Error("topic is required")},async mqttOnMessage(t,i){console.log({topic:t,message:i}),t!==this.topicConfig||"plate"!==(t=JSON.parse(i.toString())).type&&!t.img||(this.img=t.img)},async btnFullScreen(){const i=this.$refs.img;var t=_.find(["requestFullscreen","msRequestFullscreen","mozRequestFullScreen","webkitRequestFullscreen"],t=>i[t]);t&&i[t]()},showLoading(t,i){Swal.fire({title:t,text:i,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>Swal.showLoading()})},param(t,i){t=new URL(location).searchParams.get(t);return _.isNil(t)?i:t}}});</script></body></html>