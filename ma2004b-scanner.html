<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>MA2004B 掃描</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}.card.beacon{font-size:90%;letter-spacing:-1px}.card.beacon small{font-size:80%}.beacon li.list-group-item{position:relative}.beacon li.list-group-item .beacon-dropdown{position:absolute;right:.25rem;top:.25rem}</style></head><body><div class="container py-3 text-monospace" id="app" v-cloak><h3 class="text-center">MA2004B 掃描</h3><div class="row mx-n2 my-3"><div class="col mx-2 px-0"><button class="btn btn-block btn-danger" type="button" @click="btnClear">清空資料</button></div><div class="col mx-2 px-0"><button class="btn btn-block btn-success" type="button" @click="btnToggleScan" v-if="!scanning">開始掃描</button><button class="btn btn-block btn-warning" type="button" @click="btnToggleScan" v-else>停止掃描</button></div></div><template v-if="!_.keys(devices)?.length"><div class="input-group input-group-sm"><input class="form-control" readonly type="url" value="chrome://flags/#enable-experimental-web-platform-features"><div class="input-group-append"><button class="btn btn-outline-success" type="button" @click="btnCopy('chrome://flags/#enable-experimental-web-platform-features')">複製網址</button></div></div><small class="text-muted">如果無法掃描，請嘗試使用 macOS 和 Android 系統的 Google Chrome（版本大於 79）開啟，並且前往上方網址啟用 Experimental Web Platform features 功能。</small></template><div class="beacon card mt-2" v-for="device of devices"><div class="align-items-center card-header d-flex" @click="device.show = !device.show"><i class="fa fa-fw mr-2" :class="`fa-chevron-${device.show ? 'down' : 'right'}`"></i><div class="flex-fill">{{ device.name || '無名稱' }} <span class="badge badge-pill badge-primary">{{ _.keys(device?.beacons)?.length ?? 0 }}</span></div><small class="text-muted ml-2"><i class="fa mr-1 fa-clock-o"></i>{{ device.scannedAt ?? '?' }}</small><small class="text-muted ml-2"><i class="fa mr-1 fa-signal"></i>{{ device.rssi ?? '?' }}</small></div><ul class="list-group list-group-flush" v-if="device.show"><li class="list-group-item py-1" v-for="beacon of (device?.beacons ?? [])"><div class="row row-cols-2"><div class="col mt-1" @click="btnCopy(val)" v-for="[name, val] of beaconToPairs(beacon)"><small class="text-info">{{ name }}</small><div class="mt-n1">{{ val }}</div></div></div><div class="mt-1" @click="btnCopy(beacon.dm)" v-if="beacon.dm"><small class="text-info">裝置訊息</small><div class="mt-n1">{{ beacon.dm }}</div></div><div class="beacon-dropdown dropdown"><button class="btn btn-outline-secondary btn-sm" type="button" data-toggle="dropdown"><i class="fa fa-fw fa-ellipsis-v"></i></button><div class="dropdown-menu dropdown-menu-right"><a :href="oaMessage(`/mpbeacon ${beacon.mbid || beacon.hwid}`)" class="dropdown-item" target="_blank">/mpbeacon</a></div></div></li></ul></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/moment@2/locale/zh-tw.min.js" crossorigin="anonymous"></script><script src="https://taichunmin.idv.tw/proxmark3.js/proxmark3.min.js" crossorigin="anonymous"></script><script>const Packet=window.Proxmark3["Packet"],bluetooth=_.get(navigator,"bluetooth"),DISPLAY_BATTERY=["外部供電","0%","10%","20%","30%","40%","50%","60%","70%","80%","90%","100%"],UUID_LINE="0000fe6f-0000-1000-8000-00805f9b34fb",vm=new Vue({el:"#app",data:{devices:{},listened:!1,scan:null,scanning:!1},methods:{async getBluetoothAvailability(){return!0===await _.invoke(navigator,"bluetooth.getAvailability")},async btnToggleScan(){try{if(this.updateScanning(),this.scanning)this.scan.stop(),this.scan=null;else{if(!await this.getBluetoothAvailability())throw new Error("您的裝置不支援藍芽功能");this.listened||(bluetooth.addEventListener("advertisementreceived",e=>{this.onAdvertisementReceived(e)}),window.setInterval(()=>this.updateScanning(),1e3),this.listened=!0),this.scan=await bluetooth.requestLEScan({filters:[{services:[UUID_LINE]}]})}}catch(e){await Swal.fire({icon:"error",title:"藍芽掃描切換失敗",text:e.message})}},async onAdvertisementReceived(e){const t=Packet.fromView(e.serviceData.get(UUID_LINE));var a,n,i,s,r;t.byteLength<6||(a=_.trim(e?.device?.id,"="),n={...n=this.devices?.[a]??{},id:a,name:e?.device?.name||n?.name,rssi:e?.rssi,scannedAt:moment().format("HH:mm:ss"),show:n?.show??!1},s=""+((r=t.subarray(1,6).hex)??"")+((i=19!==t.byteLength?null:t.subarray(14,19).hex)??""),r={...n.beacons?.[s]??{},dm:t.subarray(7).hex,frameType:t.subarray(0,1).hex,hwid:r,id:s,mbid:i,scannedAt:n.scannedAt,txPower:e?.txPower,..._.includes([14,18,19,20],t.byteLength)?{auth:t.subarray(7,11).hex,battery:DISPLAY_BATTERY[t.getUint8(13)],maskedTimestamp:`${t.getUint16(11,!1)} (0x${t.subarray(11,13).hex})`}:{},..._.includes([18,20],t.byteLength)?{voltage:t.getUint16(16,!1)+" mV",voltageAvg:t.getUint16(14,!1)+" mV"}:{},...20!==t.byteLength?{}:{adc:`${_.round(t.getUint16(18,!1)/1024*3600)} mV (${t.getUint16(18,!1)})`}},this.isLineBeacon(r)&&_.set(n,["beacons",s],r),_.keys(n.beacons)?.length&&this.$set(this.devices,a,n))},async btnCopy(e,t=null){t=t||document.body;const a=document.createElement("textarea");a.value=e,t.appendChild(a),a.select(),a.setSelectionRange(0,1e6),document.execCommand("copy"),t.removeChild(a),await Swal.fire({icon:"success",title:"複製成功"})},isLineBeacon(e){return 10===e?.hwid?.length&&"0000000000"!==e?.hwid},beaconToPairs:(()=>{const e={mbid:"MBID",hwid:"HWID",scannedAt:"接收時間",maskedTimestamp:"時戳後四碼",auth:"驗證資料",battery:"剩餘電量",voltage:"最終顯示電壓",voltageAvg:"近5次平均電壓",adc:"ADC"};return a=>_.chain(e).map((e,t)=>[e,a?.[t]]).filter(e=>!_.isNil(e[1])).value()})(),updateScanning(){this.scanning=_.get(this,"scan.active",!1)},btnClear(){this.$set(this,"devices",{})},oaMessage(e){return"https://line.me/R/oaMessage/@youbike/?"+encodeURIComponent(e)},u8FromHex(e){return new Uint8Array(_.map(e.match(/.{2}/g),e=>_.parseInt(e,16)))},fakeLineBeacon(){this.onAdvertisementReceived({device:{id:"fake",name:"LE_00_FAKE"},rssi:_.random(-90,-30),serviceData:{get:()=>new DataView(this.u8FromHex("0201deadbeef7f037cf6f1000001").buffer)}})},fakeMpBeacon(){this.onAdvertisementReceived({device:{id:"fake",name:"LE_00_FAKE"},rssi:_.random(-90,-30),serviceData:{get:()=>new DataView(this.u8FromHex("0201deadbeef7f5cf2a4230001018c194fe41d").buffer)}})}}});</script></body></html>