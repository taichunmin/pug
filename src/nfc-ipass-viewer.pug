extends /layout/dark

block beforehtml
  - const title = 'NFC iPass Viewer'

block style
  style
    :sass
      [v-cloak]
        display: none
      body, .h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6
        font-family: 'Noto Sans TC', sans-serif
      #card
        &, input.form-control
          letter-spacing: -1px
        textarea.form-control
          font-size: 12px
        .input-group-prepend .input-group-text
          letter-spacing: -2px
          min-width: 80px

block content
  #app.my-3.container-fluid(v-cloak)
    h2.mb-3.text-center=title
    #card.text-monospace.d-flex.flex-column.flex-md-row
      .mr-sm-3
        .form-group
          label 卡片基本資料
          .row.mx-n1
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 卡片編號
              input.form-control(readonly, :value="card?.uid")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 交易序號
              input.form-control(readonly, :value="card?.ctsn")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 餘額
              input.form-control(readonly, :value="card?.ev")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 預設加值
              input.form-control(readonly, :value="card?.autoload")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 加值銀行
              input.form-control(readonly, :value="card?.bank")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 最大餘額
              input.form-control(readonly, :value="card?.quotaEv")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 單次限額
              input.form-control(readonly, :value="card?.quotaTxn")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 限額日期
              input.form-control(readonly, :value="card?.quotaDate")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 已用限額
              input.form-control(readonly, :value="card?.quotaUsed")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 身份別
              input.form-control(readonly, :value="card?.profileType")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 身份到期
              input.form-control(readonly, :value="card?.profileExp")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 卡別
              input.form-control(readonly, :value="card?.type")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 區碼
              input.form-control(readonly, :value="card?.area")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 發卡時間
              input.form-control(readonly, :value="card?.issued")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 卡片效期
              input.form-control(readonly, :value="card?.exp")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 票卡版本
              input.form-control(readonly, :value="card?.version")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 票卡狀態
              input.form-control(readonly, :value="card?.usageControl")
        .form-group
          label 轉乘紀錄
          .row.mx-n1
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 交易序號
              input.form-control(readonly, :value="card?.xfer?.txn?.ctsn")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 轉乘時間
              input.form-control(readonly, :value="card?.xfer?.time")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 轉乘前群組
              input.form-control(readonly, :value="card?.xfer?.before")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 轉乘後群組
              input.form-control(readonly, :value="card?.xfer?.after")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 轉乘類別
              input.form-control(readonly, :value="card?.xfer?.type")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 系統
              input.form-control(readonly, :value="card?.xfer?.system")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 業者
              input.form-control(readonly, :value="card?.xfer?.location")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 設備編號
              input.form-control(readonly, :value="card?.xfer?.device")
        .form-group(v-for="txn of [card?.credit]")
          label 最近加值交易
          .row.mx-n1
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 交易序號
              input.form-control(readonly, :value="txn?.ctsn")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 時間
              input.form-control(readonly, :value="txn?.time")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 交易類別
              input.form-control(readonly, :value="txn?.type")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 加值金額
              input.form-control(readonly, :value="txn?.amount")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 餘額
              input.form-control(readonly, :value="txn?.ev")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 系統
              input.form-control(readonly, :value="txn?.system")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 業者
              input.form-control(readonly, :value="txn?.spid")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 設備
              input.form-control(readonly, :value="txn?.device")
        .form-group
          label 最近扣款交易
          .table-responsive
            table.table.table-sm.table-bordered.table-striped.text-center
              thead: tr.text-nowrap
                th #
                th 時間
                th 類別
                th 扣款
                th 餘額
                th 系統
                th 業者
                th 設備
              tbody
                tr(v-for="txn of card?.deducts")
                  th {{ txn?.ctsn }}
                  td {{ txn?.time }}
                  td {{ txn?.type }}
                  td {{ txn?.amount }}
                  td {{ txn?.ev }}
                  td {{ txn?.system }}
                  td {{ txn?.spid }}
                  td {{ txn?.device }}
        .form-group(v-for="bus, busId of card?.buses")
          label 公車{{ '上下'[busId] }}車紀錄
          .row.mx-n1
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 操作員編號
              input.form-control(readonly, :value="bus?.agent")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 路線編號
              input.form-control(readonly, :value="bus?.line")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 時間
              input.form-control(readonly, :value="bus?.time")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 站牌編號
              input.form-control(readonly, :value="bus?.station")
            .mb-1.px-1.col-12.col-md-6.col-lg-4.col-xl-3: .input-group.input-group-sm
              .input-group-prepend: span.input-group-text.justify-content-center 區段編號
              input.form-control(readonly, :value="bus?.zone")
        .form-group
          label 進出站紀錄
          .table-responsive
            table.table.table-sm.table-bordered.table-striped.text-center
              thead: tr.text-nowrap
                th 時間
                th 進出站
                th 業者
                th 場站
                th 累計次數
                th 累計金額
              tbody
                tr(v-for="mrt of card?.mrts")
                  td {{ mrt?.time }}
                  td {{ mrt?.type }}
                  td {{ mrt?.spid }}
                  td {{ mrt?.location }}
                  td {{ mrt?.count }}
                  td {{ mrt?.amount }}
        .form-group
          label Mifare 卡片金鑰
          .row.mx-n1
            .mb-1.px-1.col-12.col-md-6: .input-group.input-group-sm(@click="btnCopy(card?.keya)")
              .input-group-prepend: span.input-group-text.justify-content-center keyA
              textarea.form-control(readonly, rows="16", :value="card?.keya")
            .mb-1.px-1.col-12.col-md-6: .input-group.input-group-sm(@click="btnCopy(card?.keyb)")
              .input-group-prepend: span.input-group-text.justify-content-center keyB
              textarea.form-control(readonly, rows="16", :value="card?.keyb")
      .form-group(style="min-width: 250px")
        label EML (HEX)
        textarea.form-control.form-control-sm(rows="65", v-model="h.eml")

block script
  script(crossorigin="anonymous", src="https://taichunmin.idv.tw/proxmark3.js/proxmark3.min.js")
  script.
    const { BufferLE } = window.Proxmark3
    class Ipass {
      constructor (buf) {
        if (!buf || !(buf instanceof BufferLE) || buf.byteLength !== 1024) throw new TypeError('invalid buf')
        this.buf = buf
        this.credit = this.getTxn(160) // 最近加值交易
        this.deducts = _.chain([16, 17, 18, 20, 21, 22]).map(blk => this.getTxn(blk << 4)).sortBy(['time']).value() // 最近扣款交易
      }

      static fromEml (eml) {
        eml = eml.replace(/-/g, '0').replace(/[^0-9A-Fa-f]/g, '')
        if (eml.length !== 2048) throw new TypeError('錯誤的 eml')
        return new Ipass(BufferLE.fromHex(eml))
      }

      getUnixStr (buf, pos) {
        return dayjs.unix(buf.getUint32(pos) - 28800).format('YYYY-MM-DD HH:mm:ss')
      }

      getTxn (pos) { // 16 bytes: 34 7C3D4E62 30 2823 F726 AD 01 2EBD0100
        const buf = this.buf
        return {
          ctsn: `0x${buf.subarray(pos, pos + 1).hex}`,
          time: this.getUnixStr(buf, pos + 1),
          type: `0x${this.buf.subarray(pos + 5, pos + 6).hex}`,
          amount: buf.getInt16(pos + 6),
          ev: buf.getInt16(pos + 8),
          system: `0x${this.buf.subarray(pos + 10, pos + 11).hex}`,
          spid: `0x${this.buf.subarray(pos + 11, pos + 12).hex}`,
          device: `0x${this.buf.subarray(pos + 12, pos + 16).hex}`,
        }
      }

      get keya () {
        const buf = this.buf
        return _.uniq(_.times(16, i => buf.subarray((i << 6) + 48, (i << 6) + 54).hex)).join('\n')
      }

      get keyb () {
        const buf = this.buf
        return _.uniq(_.times(16, i => buf.subarray((i << 6) + 58, (i << 6) + 64).hex)).join('\n')
      }

      get uid () { return this.buf.subarray(0, 4).hex } // 卡片編號
      get csn () { return this.buf.subarray(0, 16).hex } // 卡號 (16 bytes)
      get type () { return `0x${this.buf.subarray(448, 449).hex}` } // 一卡通票卡種類 (1 byte)
      get issuer () { return `0x${this.buf.subarray(64, 65).hex}` } // 發卡單位編號 (1 byte)
      get ev () { return this.buf.getUint32(128) } // 電子票值 (4 bytes)
      get ctsn () { return `0x${this.buf.subarray(192, 194).rhex}` } // 交易序號
      get quotaEv () { return this.buf.getUint16(83) } // 儲值最大票值數額 (2 bytes)
      get quotaTxn () { return this.buf.getUint16(85) } // 單筆最大扣值金額 (2 bytes)
      get profileType () { return `0x${this.buf.subarray(384, 385).hex}` } // 個人身份別 (1 byte)
      get profileExp () { return this.getUnixStr(this.buf, 181) } // 身份到期 (4 byte)
      get issued () { return this.getUnixStr(this.buf, 69) } // 票卡發行日期 (4 bytes)
      get exp () { return this.getUnixStr(this.buf, 73) } // 票卡發行日期 (4 bytes)
      get version () { return `0x${this.buf.subarray(77, 78).hex}` } // 票卡版本 (1 byte)

      get xfer () { // 轉乘
        const txnIdx = this.buf.getUint8(194) // 交易紀錄位置
        return {
          txnIdx,
          time: this.getUnixStr(this.buf, 195),
          after: `0x${this.buf.subarray(199, 200).hex}`,
          before: `0x${this.buf.subarray(200, 201).hex}`,
          type: `0x${this.buf.subarray(201, 202).hex}`,
          system: `0x${this.buf.subarray(202, 203).hex}`,
          location: `0x${this.buf.subarray(203, 204).hex}`,
          device: `0x${this.buf.subarray(204, 208).hex}`,
          txn: txnIdx ? this.getTxn([null, 16, 17, 18, 20, 21, 22][txnIdx] << 4) : null,
        }
      }
    }
    window.vm = new Vue({
      el: '#app',
      data: {
        ready: false,
        h: {
          eml: '',
        },
      },
      async mounted () {
        // 自動儲存功能
        try {
          const saved = JSON5.parse(localStorage.getItem(location.pathname))
          if (saved) this.$set(this, 'h', { ...this.h, ...saved })
        } catch (err) {}
        this.$watch('h', () => {
          localStorage.setItem(location.pathname, JSON5.stringify(this.h))
        }, { deep: true })

        await this.init()
      },
      computed: {
        card () {
          try {
            if (!this.ready) return
            return Ipass.fromEml(this.h.eml)
          } catch (err) {
            console.error(err)
          }
        },
      },
      methods: {
        async init () {
          try {
            this.ready = true
          } catch (err) {
            console.error(err)
            Swal.fire({ icon: 'error', title: '發生錯誤', text: err.message })
          }
        },
        async btnCopy (text, container = null) {
          if (!container) container = document.body
          const dom = document.createElement('textarea')
          dom.value = text
          container.appendChild(dom)
          dom.select()
          dom.setSelectionRange(0, 1e6) // For mobile devices
          document.execCommand('copy')
          container.removeChild(dom)
          await Swal.fire({ icon: 'success', title: '複製成功' })
        },
      },
    })
