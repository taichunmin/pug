<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>MPPARKQA 主控端</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,body,h1,h2,h3,h4,h5,h6{font-family:"Noto Sans TC",sans-serif}.img-plate{width:60%;aspect-ratio:16/9;border-radius:.25rem 0 0 .25rem}</style></head><body><div class="container my-3 text-monospace" id="app" v-cloak><h2 class="mb-3 text-center">MPPARKQA 主控端</h2><div class="row"><div class="col-12 col-md-3"><div class="form-group"><label class="d-flex align-items-center mb-0"><i class="mr-1 fa fa-wifi text-success" v-if="conn"></i><i class="mr-1 fa fa-wifi text-danger" v-else></i>MQTT 伺服器</label><button class="btn btn-block mt-2 btn-success" type="button" @click="btnMqttConnect">連線到伺服器</button><button class="btn btn-block mt-2 btn-primary" type="button" @click="btnDeviceAdd('plate')">新增車牌螢幕</button><button class="btn btn-block mt-2 btn-outline-danger" type="button" @click="btnReset">重設所有資料</button></div><div class="form-group"><label class="mb-0">車牌相簿</label><button class="btn btn-block mt-2 btn-success" type="button">重新抓取相簿</button><button class="btn btn-block mt-2 btn-primary" type="button">修改 CSV 網址</button></div></div><div class="col-12 col-md-9"><div class="card" v-for="device of devices"><div class="d-flex"><template v-for="deviceImg of [device?.config?.img ?? 'https://i.imgur.com/aFjrHcA.png']"><img :key="deviceImg" :src="deviceImg" class="img-plate"></template><div class="card-body"><h5 class="d-flex align-items-center card-title"><template v-for="deviceStatus of [device?.state?.status]"><i class="mr-1 fa fa-wifi text-success" v-if="deviceStatus === 'online'"></i><i class="mr-1 fa fa-wifi text-danger" v-else-if="deviceStatus === 'offline'"></i><i class="mr-1 fa fa-question-circle text-secondary" v-else></i></template><span class="mr-1">車牌螢幕</span><pre class="mb-0">{{ device.id }}</pre></h5><button class="btn btn-block mt-2 btn-sm btn-success" type="button" @click="btnDeviceQr(device)">螢幕 QR 碼</button><button class="btn btn-block mt-2 btn-primary btn-sm" type="button" @click="btnPlateSetImg(device)">切換圖片</button><button class="btn btn-block mt-2 btn-sm btn-outline-danger" type="button" @click="btnPlateDel(device)">刪除設備</button></div></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qrcode@1/build/qrcode.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/mqtt@4/dist/mqtt.min.js" crossorigin="anonymous"></script><script>window.middlewareCompose=e=>{if(!_.isArray(e))throw new TypeError("Middleware stack must be an array!");if(_.some(e,t=>!_.isFunction(t)))throw new TypeError("Middleware must be composed of functions!");return async(i={},t)=>{const a=[...e,..._.isFunction(t)?[t]:[]],o=_.times(a.length+1,()=>0),r=async e=>{if(0!==o[e])throw new Error(`middleware[${e}] called multiple times`);if(e>=a.length)o[e]=2;else try{o[e]=1;var t=await a[e](i,()=>r(e+1));if(1===o[e+1])throw new Error(`next() in middleware[${e}] should be awaited`);return o[e]=2,t}catch(t){throw o[e]=3,t}};return r(0)}};const mqttOnMessageHandler=window.middlewareCompose([async(t,e)=>{const{message:i,topic:a,vm:o}=t,r=/^mpparkqa\/([^/]+)\/(config|state)$/.exec(a);return r&&(t=_.find(o.devices,t=>t.id===r[1]))?void("plate"===i.type&&o.$set(t,r[2],i)):e()}]);window.vm=new Vue({el:"#app",data:{conn:null,devices:[],h:{album:"",mqttHost:"wss://rw:readwrite@test.mosquitto.org:8091",devices:[]}},async mounted(){try{var t=JSON5.parse(localStorage.getItem(location.pathname));t&&this.$set(this,"h",{...this.h,...t})}catch(t){}this.$watch("h",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.h))},{deep:!0})},methods:{async btnMqttConnect(){try{const a=(await Swal.fire({input:"url",inputLabel:"只能輸入 wss:// 的網址",inputValue:this.h.mqttHost,showCancelButton:!0,title:"MQTT 伺服器網址",inputAttributes:{autocapitalize:"none",autocorrect:"off",inputmode:"url"},inputValidator:t=>{try{if("wss:"!==new URL(t).protocol)throw new Error("只能輸入 wss:// 的網址")}catch(t){return t.message}}}))["value"];if(!a)return;this.showLoading("請稍候","正在連線到 MQTT 伺服器"),this.h.mqttHost=a,this.conn=await new Promise((t,e)=>{const i=window.mqtt.connect(a);i.on("connect",()=>t(i)),i.on("error",t=>e(t))}),this.conn.on("message",this.mqttOnMessage),await Promise.all(_.map(this.h.devices,async t=>{if("plate"===t.type)return this.mqttPlateAdd(t)})),Swal.close()}catch(t){console.error(t),await Swal.fire({icon:"error",title:"連線失敗",text:t.message})}},async btnDeviceAdd(t){var e=(await Swal.fire({input:"text",inputLabel:`程式會幫設備名稱前加上 ${t}- 前綴`,showCancelButton:!0,title:"請輸入設備名稱",inputValidator:t=>/^[^/#+]+$/.test(t)?null:"含有非法字元",inputAttributes:{autocapitalize:"none",autocorrect:"off",inputmode:"url"}}))["value"];e&&(this.h.devices.push(t={type:t,id:t+"-"+e}),await this.mqttPlateAdd(t))},async btnDeviceQr(t){try{const i=new URL("mpparkqa-mqtt-plate.html",location);i.searchParams.set("device",t.id),i.searchParams.set("host",this.h.mqttHost);var e=await QRCode.toString(i.href,{margin:0});await Swal.fire({title:t.id,html:e})}catch(t){console.error(t),await Swal.fire({icon:"error",title:"發生錯誤",text:t.message})}},async btnPlateSetImg(t){try{var e=(await Swal.fire({input:"url",inputLabel:"只能輸入 https:// 的網址",inputValue:t?.config?.img,showCancelButton:!0,title:"新的圖片網址",inputAttributes:{autocapitalize:"none",autocorrect:"off",inputmode:"url"},inputValidator:t=>{try{if("https:"!==new URL(t).protocol)throw new Error("只能輸入 https:// 的網址")}catch(t){return t.message}}}))["value"];if(!e)return;this.showLoading("請稍候","正在切換圖片..."),await this.mqttPublish(t.topicConfig,{type:"plate",img:e},{qos:1,retain:!0}),Swal.close()}catch(t){console.error(t),await Swal.fire({icon:"error",title:"發生錯誤",text:t.message})}},async btnReset(t=!0){if(!t||(t=await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"保持原樣",confirmButtonColor:"#d33",confirmButtonText:"重設資料",focusCancel:!0,icon:"warning",showCancelButton:!0,text:"是否重設本頁面的資料？"})).value)return localStorage.removeItem(location.pathname),location.reload(),new Promise(t=>{})},async mqttSubscribe(t,e){return new Promise((i,a)=>{this.conn.subscribe(t,e,(t,e)=>t?a(t):i(e))})},async mqttUnsubscribe(t){return new Promise((e,i)=>{this.conn.unsubscribe(t,t=>t?i(t):e())})},async mqttPublish(t,a,o){if(_.isString(t))return _.isString(a)||(a=JSON.stringify(a)),new Promise((e,i)=>{this.conn.publish(t,a,o,t=>t?i(t):e())});throw new Error("topic is required")},async mqttOnMessage(t,e){try{e=JSON.parse(e.toString()),console.log({topic:t,message:e}),await mqttOnMessageHandler({message:e,topic:t,vm:this})}catch(t){console.error(t)}},async mqttPlateAdd(t){try{if(!t?.id)throw new Error("device.id is required");this.showLoading("請稍候","正在新增設備..."),t={...t,config:null,state:null,topicConfig:`mpparkqa/${t.id}/config`,topicState:`mpparkqa/${t.id}/state`},this.devices.push(t),await this.mqttSubscribe([t.topicConfig,t.topicState],{qos:1}),Swal.close()}catch(t){console.error(t),await Swal.fire({icon:"error",title:"發生錯誤",text:t.message})}},async btnPlateDel(e){try{this.showLoading("請稍候","正在移除設備..."),await this.mqttUnsubscribe([e.topicConfig,e.topicState]);let t=this.devices.indexOf(e);0<=t&&this.devices.splice(t,1),0<=(t=_.findIndex(this.h.devices,["id",e.id]))&&this.h.devices.splice(t,1),Swal.close()}catch(t){console.error(t),await Swal.fire({icon:"error",title:"發生錯誤",text:t.message})}},showLoading(t,e){Swal.fire({title:t,text:e,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>Swal.showLoading()})}}});</script></body></html>