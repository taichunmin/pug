<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>微程式 OTA 工具 MA2004B</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><meta content="2133031763635285" property="fb:app_id"><meta content="微程式 OTA 工具 MA2004B" property="og:description"><meta content="zh_TW" property="og:locale"><meta content="筆記國度" property="og:site_name"><meta content="微程式 OTA 工具 MA2004B" property="og:title"><meta content="website" property="og:type"><meta content="https://taichunmin.idv.tw/pug/mpota-ma2004b.html" property="og:url"><style>[v-cloak]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,body,h1,h2,h3,h4,h5,h6{font-family:"Noto Sans TC",sans-serif}.card .input-group-sm .input-group-text{letter-spacing:-1px;min-width:4.5rem}</style></head><body><div class="container-fluid my-3" id="app" style="max-width:760px" v-cloak><h3 class="mb-3 text-center">微程式 OTA 工具 MA2004B</h3><div class="card mb-4"><div class="card-body text-monospace"><h5 class="card-title my-0">設定值</h5><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">選擇韌體</span></div><select class="custom-select" v-model="h.fw"><option value="https://gcs-youbike2-linebot.taichunmin.idv.tw/ma2004b-firmwares/hash_MA2004B_v1_0_r3.bin">正式版 R3</option><option value="https://gcs-youbike2-linebot.taichunmin.idv.tw/ma2004b-firmwares/hash_MA2004B_v1_0_r2.bin">正式版 R2</option><option value="https://gcs-youbike2-linebot.taichunmin.idv.tw/ma2004b-firmwares/hash_MA2004B_v1_0_t5_3.bin">測試電壓值 (v1_0_t5_3)</option></select></div><div class="was-validated"><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">參數清單<br>CSV</span></div><textarea class="form-control" inputmode="url" pattern=".+" required rows="4" v-model="h.ma2004bCsv"></textarea></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">回報金鑰</span></div><input class="form-control" v-model="h.secret" inputmode="url" maxlength="32" pattern="\w{32}" placeholder="如果需要安裝回報請填寫金鑰" required type="password"></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">產品序號</span></div><input class="form-control" v-model="h.sn" inputmode="url" maxlength="13" pattern="\w{13}" placeholder="留空代表從藍牙讀取" required></div></div><div class="mt-2 form-check"><input class="form-check-input" v-model="h.autoNext" type="checkbox" :disabled="!h.sn" id="h-autoNext"><label class="form-check-label" for="h-autoNext">產品參數更新成功後自動換下一筆</label></div></div></div><div class="card mb-4"><div class="card-body text-monospace"><h5 class="card-title">操作</h5><button @click="btnUploadFirmware" class="mt-2 btn btn-block btn-outline-primary" type="button"><span class="fa fa-fw fa-cloud-upload"></span> 執行韌體更新</button><button @click="btnUpdateSetting" class="mt-2 btn btn-block btn-outline-success" type="button"><span class="fa fa-fw fa-cogs"></span> 更新產品參數</button><button @click="btnIncTimestamp" class="mt-2 btn btn-block btn-outline-secondary" type="button"><span class="fa fa-fw fa-clock-o"></span> 增加時間戳記</button><button @click="btnReset" class="mt-2 btn btn-block btn-outline-danger" type="button"><span class="fa fa-fw fa-trash-o"></span> 重設本頁資料</button></div></div><div class="card mb-4"><div class="card-header"><span class="fa fa-fw fa-flag"></span> Beacon 安裝回報</div><ul class="text-monospace list-group list-group-flush" v-if="h.registers.length"><li :key="row.sn" class="d-flex flex-column list-group-item px-3 py-2" v-for="row in h.registers"><small class="text-muted">{{ row.time }}</small><div class="mb-2">產品序號 {{ row.sn }}</div><a :href="getBeaconRegisterUrl(hwid)" :key="hwid" class="btn btn-outline-primary mb-2" target="_blank" v-for="hwid in row.hwids">回報 {{ hwid }}</a></li></ul><div class="card-body" v-else>無資料</div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/crypto-js@4/crypto-js.min.js" crossorigin="anonymous"></script><script>const ERRCODE_08={2001:"低電量無法更新",2002:"韌體型號不符",2003:"資料傳輸方式有誤",2004:"更新流程有誤",4001:"更新檔寫入失敗",4002:"更新檔讀取失敗",4003:"資料清除失敗",8001:"更新檔驗證失敗 8001",8002:"更新檔驗證失敗 8002",8003:"更新檔驗證失敗 8003"},sleep=(window.errToPlainObj=(()=>{const t=["address","code","data","dest","errno","info","message","name","path","port","reason","response.data","response.headers","response.status","stack","status","statusCode","statusMessage","syscall"];return e=>_.pick(e,t)})(),window.htmlEscape=(()=>{const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e=>e.replace(/[&<>"']/g,e=>t[e])})(),window.encodeBase64url=e=>(_.isInteger(e.sigBytes)||(e=CryptoJS.enc.Utf8.parse(""+e)),CryptoJS.enc.Base64.stringify(e).replace(/[+/=]/g,e=>_.get({"+":"-","/":"_","=":""},e))),window.hs256Base64url=(e,t)=>{if(!_.isString(e))throw new Error("invalid msg");if(_.isString(t)&&t)return window.encodeBase64url(CryptoJS.HmacSHA256(e,t));throw new Error("invalid secret")},window.httpBuildQuery=(e,t={})=>Qs.stringify(e,{arrayFormat:"brackets",...t}),t=>new Promise(e=>{setTimeout(e,t)}));class GoogleFormClass{constructor(e){if(e=new URL(e),!this.constructor.isViewFormUrl(e))throw new Error("不是一個合法的 Google 表單預填連結: "+e);this.urlFormResponse=new URL("./formResponse",e).href,this.params=_.filter([...e.searchParams],e=>/^entry\./.test(e[0]))}async post(t){const r={};_.each(this.params,e=>{r[e[0]]=_.toString(_.get(t,e[1],""))}),await axios.post("https://us-central1-youbike2-linebot.cloudfunctions.net/cors-anywhere",window.httpBuildQuery(r),{params:{u:this.urlFormResponse}})}static isViewFormUrl(e){return"https://docs.google.com"===e.origin&&/^\/forms\/d\/e\/[0-9a-zA-Z_-]+\/viewform$/.test(e.pathname)}}window.vm=new Vue({el:"#app",data:{bleCharNotify:null,bleCharWrite:null,bleService:null,device:null,logUpdateSetting:null,model:"MA2004B",otaEntered:0,ua:"",uuidNotify:"7e400003-b5a3-f393-e0a9-e50e24dcca9e",uuidService:"7e400001-b5a3-f393-e0a9-e50e24dcca9e",uuidWrite:"7e400002-b5a3-f393-e0a9-e50e24dcca9e",h:{autoNext:!0,fw:"https://gcs-youbike2-linebot.taichunmin.idv.tw/ma2004b-firmwares/hash_MA2004B_v1_0_r3.bin",ma2004bCsv:"",registers:[],secret:"",sn:""}},async mounted(){try{var e=JSON5.parse(localStorage.getItem(location.pathname));e&&this.$set(this,"h",{...this.h,...e})}catch(e){}this.$watch("h",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.h))},{deep:!0}),this.logUpdateSetting=new GoogleFormClass("https://docs.google.com/forms/d/e/1FAIpQLSfiiHf0vgFZ-gVpdz-5LCz51_ZE4pzX6OIShM40nStgq8z3MA/viewform?usp=pp_url&entry.135843282=snBefore&entry.1788349406=snAfter&entry.1455481659=ua&entry.1961450447=setting"),this.ua=navigator.userAgent},computed:{version(){var e=this.h.fw.match(/hash_MA2004B_([^.]+).bin/);return e?e[1]:null}},methods:{async btnUploadFirmware(){try{this.showLoading("請稍候","搜尋裝置及下載韌體中…");const[a,l]=[16,16];let r;await Promise.all([this.bleSearchDevice(),(async()=>{r=await _.get(await axios.get(this.h.fw,{params:{cachebust:_.floor(Date.now()/864e5)},responseType:"blob"}),"data").arrayBuffer(),this.logTime(`韌體更新檔下載成功，大小為 ${r.byteLength} bytes`);var e,t=l-r.byteLength%l;t<l&&(e=new ArrayBuffer(r.byteLength+t),new Uint8Array(e).set(new Uint8Array(r)),new Uint8Array(e,r.byteLength).fill(255),r=e,this.logTime(`韌體更新檔後面填充了 ${t} bytes`))})()]),this.showLoading("請稍候","取得裝置資訊中…");var e=await this.bleGetFirmwareUpdateInfo(this.model);if(e.version===this.version)if(!(await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"取消更新",confirmButtonColor:"#d33",confirmButtonText:"強制更新",focusCancel:!0,icon:"warning",reverseButtons:!0,showCancelButton:!0,text:`韌體版本已經是 ${e.version}，是否強制更新？`})).value)return;this.showLoading("請稍候","正在上傳韌體…");const h=r.byteLength/l,c=(this.logTime(`設定韌體傳輸參數: 確認頻率 ${a}，每個封包 ${l} bytes，共 ${h} 個封包`),await this.bleUploadFirmwareStep1(a,l,h),(()=>{const r={max:h};return e=>{var t=Date.now();_.toSafeInteger(r.expiredAt)>=t||(r.expiredAt=t+5e3,t=(e=Math.min(Math.max(0,e),r.max))===r.max?100:_.floor(e/r.max*100),this.showLoading("韌體更新進度",`${e} / ${r.max} (${t}%)`))}})());for(let e=0;e<h;e++){c(e);var t=(e+1)%a==0,i=await this.bleUploadFirmwareStep2(r,e*l,l,t);if(t){var n=a*l,o=(e+1-a)*l,s=_.reduce(new Uint8Array(r,o,n),(e,t)=>e^t,0);if(s!==i.crc)throw new Error(`crc 驗證失敗: crcStart = ${o}, crcLen = ${n}, crc = ${s}, res.crc = `+i.crc)}}await this.bleUploadFirmwareStep3(),await Swal.fire({icon:"success",title:"韌體更新成功"})}catch(e){console.error(e),await Swal.fire({icon:"error",title:"韌體更新失敗",text:e.message})}finally{await this.bleDisconnect()}},async btnUpdateSetting(){const i={};try{this.showLoading("請稍候","搜尋裝置及下載參數清單中…");let e=[],t=(await Promise.all([this.bleSearchDevice(),(async()=>{e=await this.fetchMa2004bs(),this.logTime(`參數清單中有 ${e.length} 筆紀錄`)})()]),this.showLoading("請稍候","核對產品序號中…"),this.h.sn);if(this.isValidSn(t)||(this.logTime("嘗試從藍牙讀取產品序號"),t=await this.bleGetSn()),!this.isValidSn(t))throw new Error("產品序號有誤: "+t);if(this.logTime("產品序號為 "+t),i.after=_.find(e,e=>e.sn===t),!i.after)throw new Error("參數清單中找不到該產品序號");this.showLoading("請稍候","更新參數中…"),i.before=await this.bleGetBeacons();for(let r=0;r<3;r++){let t=!0;_.each(["hwid","vendorKey","lotKey"],e=>{i.after[""+e+r]!==i.before[""+e+r]&&(t=!1)}),!t||BigInt("0x"+i.before["timestamp"+r])<BigInt("0x"+i.after["timestamp"+r])||(this.logTime("繼承 timestamp"+r),i.after["timestamp"+r]=i.before["timestamp"+r])}await this.bleSetBeacons(i.after),await this.bleSetTxPower(0),await this.bleSetAdvInterval(243),this.logTime(`產品序號 ${t} 參數更新成功`);var r,n,o=[{sn:i.after.sn,time:dayjs().format("YYYY-MM-DD HH:mm:ss"),hwids:_.filter(_.times(3,e=>{e=2===_.toSafeInteger(_.get(i,"after.mode"+e))?_.get(i,"after.lotKey"+e).slice(0,10):_.get(i,"after.hwid"+e);if(e&&"0000000000"!==e)return e}))},..._.get(this,"h.registers",[])];this.$set(this.h,"registers",_.take(_.uniqBy(o,"sn"),3)),await this.logUpdateSetting.post({snBefore:_.get(i,"before.sn","無資料"),snAfter:_.get(i,"after.sn","無資料"),ua:this.ua,setting:JSON5.stringify(_.pick(i,["before","after"]))}),this.h.sn&&this.h.autoNext&&(r=e.indexOf(i.after),(n=_.get(e,[r+1,"sn"]))&&(this.h.sn=n)),await Swal.fire({icon:"success",title:"參數更新成功",text:"產品序號 "+t})}catch(e){console.error(e),await Swal.fire({icon:"error",title:"參數更新失敗",text:e.message})}finally{await this.bleDisconnect(),console.log("ctx = ",i)}},async btnIncTimestamp(){const t={};try{this.showLoading("搜尋裝置中"),await this.bleSearchDevice(),this.showLoading("請稍候","讀取參數中…"),t.before=await this.bleGetBeacons();var e=_.get(t,"before.sn");if(!e)throw new Error("無法取得產品序號");if(!(await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"取消執行",confirmButtonColor:"#d33",confirmButtonText:"確認執行",focusCancel:!0,icon:"warning",reverseButtons:!0,showCancelButton:!0,text:`產品序號 ${t.before.sn} 的時戳將會增加 34 天，請確認是否執行？`})).value)return;this.showLoading("請稍候","增加時戳中…"),t.after={...t.before};for(let e=0;e<3;e++)t.after["timestamp"+e]=this.toHexZerofill(BigInt("0x"+t.after["timestamp"+e])+0x30000n,16);await this.bleSetBeacons(t.after),await this.bleSetTxPower(0),await this.bleSetAdvInterval(243),this.logTime(`產品序號 ${e} 增加時戳成功`),await this.logUpdateSetting.post({snBefore:_.get(t,"before.sn","無資料"),snAfter:_.get(t,"after.sn","無資料"),ua:this.ua,setting:JSON5.stringify(_.pick(t,["before","after"]))}),await Swal.fire({icon:"success",title:"增加時戳成功",text:"產品序號 "+e})}catch(e){console.error(e),await Swal.fire({icon:"error",title:"增加時戳失敗",text:e.message})}finally{await this.bleDisconnect(),console.log("ctx = ",t)}},async btnReset(e=!0){if(!e||(e=await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"保持原樣",confirmButtonColor:"#d33",confirmButtonText:"重設資料",focusCancel:!0,icon:"warning",reverseButtons:!0,showCancelButton:!0,text:"是否重設本頁面的資料？"})).value)return localStorage.removeItem(location.pathname),location.reload(),new Promise(e=>{})},fetchMa2004bs:function(){const t={};return async function(){var e=Date.now();if(this.h.ma2004bCsv)return(t.url!==this.h.ma2004bCsv||_.toSafeInteger(t.expiredAt)<e)&&(t.cache=await this.fetchCsvCors(this.h.ma2004bCsv),t.url=this.h.ma2004bCsv,t.expired=e+36e5),t.cache;throw new Error("請填寫參數清單 CSV 網址")}}(),async fetchCsvCors(e,t=3e5){(e=new URL(e)).searchParams.set("cachebust",_.floor(Date.now()/t));t=_.trim(_.get(await axios.get("https://us-central1-youbike2-linebot.cloudfunctions.net/cors-anywhere",{params:{u:e.href}}),"data"));return _.get(Papa.parse(t,{encoding:"utf8",header:!0}),"data",[])},bleNewRequest80({ack:e=!0,cmd:t,len:r=0}){if(!_.inRange(t,0,256))throw new Error("cmd 有誤");if(!_.inRange(r,0,16384))throw new Error("len 有誤");var i=new ArrayBuffer(r+4);const n={ack:e,body:new DataView(i,4),buffer:i,frame:new DataView(i),len:r};return n.frame.setUint8(0,128),n.frame.setUint16(1,(e?32768:0)+r,!0),n.frame.setUint8(3,t),n},async bleGetFirmwareUpdateInfo(e){if(!_.isString(e))throw new Error("model 有誤");var e=(new TextEncoder).encode(e).buffer,t=this.bleNewRequest80({cmd:240,len:e.byteLength});new Uint8Array(t.buffer,4).set(new Uint8Array(e));const r=await this.bleSendRequest({req:t});if(20===r.len&&20===_.sumBy(new Uint8Array(r.buffer,4),e=>255===e))throw new Error("錯誤的裝置型號");return{updatedCnt:r.body.getUint32(0),version:(new TextDecoder).decode(r.buffer.slice(8))}},async bleUploadFirmwareStep1(e,t,r){if(!_.inRange(e,0,256))throw new Error("ackFreq 必須介於 0x1 和 0xff 之間");if(!_.inRange(t,4,16384))throw new Error("blockSize 必須介於 0x4 和 0x3fff 之間");if(!_.inRange(r,0,4294967296))throw new Error("blockCnt 有誤");const i=this.bleNewRequest80({cmd:241,len:8}),n=(i.body.setUint8(0,1),i.body.setUint8(1,e),i.body.setUint16(2,t),i.body.setUint32(4,r),await this.bleSendRequest({req:i,timeout:22e3}));var o={code:this.toHexZerofill(n.body.getUint16(0),4),ackFreq:n.body.getUint8(2),blockSize:n.body.getUint16(3),blockCnt:n.body.getUint32(5)};if("0001"!==o.code)throw new Error(ERRCODE_08[o.code]||"未知錯誤 "+o.code);if(e!==o.ackFreq)throw new Error("ackFreq 設定失敗");if(t!==o.blockSize)throw new Error("blockSize 設定失敗");if(r!==o.blockCnt)throw new Error("blockCnt 設定失敗");return o},bleUploadFirmwareStep2:(()=>{const s={};return async function(e,t,r,i){if(!(e instanceof ArrayBuffer))throw new Error("file 的型態有誤");if(!_.isSafeInteger(t)||t<0)throw new Error("file 的 start 有誤");if(!_.isSafeInteger(r)||r<1)throw new Error("file 的 len 有誤");if(t+r>e.byteLength)throw new Error("start + len 超過 file 的大小");var n="reqs."+(i?"y":"n")+r,n=(_.get(s,n)||_.set(s,n,this.bleNewRequest80({ack:i,cmd:242,len:r})),_.get(s,n));new Uint8Array(n.buffer,4).set(new Uint8Array(e,t,r));const o=await this.bleSendRequest({req:n,verbose:!1});if(i){e={code:this.toHexZerofill(o.body.getUint16(0),4),crc:o.body.getUint8(2)};if("0001"!==e.code)throw new Error(ERRCODE_08[e.code]||"未知錯誤 "+e.code);return e}}})(),async bleUploadFirmwareStep3(){var e=this.bleNewRequest80({cmd:243});const t=await this.bleSendRequest({req:e});e={code:this.toHexZerofill(t.body.getUint16(0),4)};if("0001"!==e.code)throw new Error(ERRCODE_08[e.code]||"未知錯誤 "+e.code);return e},bleNewRequest25({cmd:e,len:t=0}){if(!_.inRange(e,0,256))throw new Error("cmd 有誤");if(!_.isSafeInteger(t)||t<0)throw new Error("len 有誤");var r=new ArrayBuffer(t+3);const i={ack:!0,body:new DataView(r,2,t),buffer:r,frame:new DataView(r),len:t};return i.frame.setUint8(0,37),i.frame.setUint8(1,e),i.frame.setUint8(t+2,43),i},async bleGetFirmwareVersion(){var e=this.bleNewRequest25({cmd:59});const t=await this.bleSendRequest({req:e});return(new TextDecoder).decode(t.buffer.slice(2,t.buffer.byteLength-1))},async bleGetTxPower(){var e=this.bleNewRequest25({cmd:53});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return t.body.getUint8(0);throw new Error("txPower 讀取失敗")},async bleGetAdvInterval(){var e=this.bleNewRequest25({cmd:54});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return t.body.getUint32(0);throw new Error("advInterval 讀取失敗")},async bleGetSn(){var e=this.bleNewRequest25({cmd:55});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return(new TextDecoder).decode(t.buffer.slice(2,t.buffer.byteLength-2)).replace(/_/g,"");throw new Error("sn 讀取失敗")},async bleGetHwidV1(){var e=this.bleNewRequest25({cmd:56});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return _.times(5,e=>this.toHexZerofill(t.body.getUint8(e),2)).join("");throw new Error("hwid 讀取失敗")},async bleGetLotKeyV1(){var e=this.bleNewRequest25({cmd:57});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return _.times(8,e=>this.toHexZerofill(t.body.getUint8(e),2)).join("");throw new Error("lotKey 讀取失敗")},async bleGetVendorKeyV1(){var e=this.bleNewRequest25({cmd:58});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return _.times(4,e=>this.toHexZerofill(t.body.getUint8(e),2)).join("");throw new Error("lotKey 讀取失敗")},async bleGetModeV1(){var e=this.bleNewRequest25({cmd:61});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return t.body.getUint8(0);throw new Error("mode 讀取失敗")},async bleGetHwidV2(e){if(!_.inRange(e,0,3))throw new Error("channel 必須介於 0 到 2 之間");const t=this.bleNewRequest25({cmd:81,len:1}),r=(t.body.setUint8(0,e),await this.bleSendRequest({req:t}));if(!r.body.getUint8(r.len-1))throw new Error("hwid 讀取失敗");if(r.body.getUint8(0)!==e)throw new Error(`channel 回傳值有誤: req = ${e}, res = `+r.body.getUint8(0));return _.times(5,e=>this.toHexZerofill(r.body.getUint8(e+1),2)).join("")},async bleGetLotKeyV2(e){if(!_.inRange(e,0,3))throw new Error("channel 必須介於 0 到 2 之間");const t=this.bleNewRequest25({cmd:82,len:1}),r=(t.body.setUint8(0,e),await this.bleSendRequest({req:t}));if(!r.body.getUint8(r.len-1))throw new Error("lotKey 讀取失敗");if(r.body.getUint8(0)!==e)throw new Error(`channel 回傳值有誤: req = ${e}, res = `+r.body.getUint8(0));return _.times(8,e=>this.toHexZerofill(r.body.getUint8(e+1),2)).join("")},async bleGetVendorKeyV2(e){if(!_.inRange(e,0,3))throw new Error("channel 必須介於 0 到 2 之間");const t=this.bleNewRequest25({cmd:83,len:1}),r=(t.body.setUint8(0,e),await this.bleSendRequest({req:t}));if(!r.body.getUint8(r.len-1))throw new Error("vendorKey 讀取失敗");if(r.body.getUint8(0)!==e)throw new Error(`channel 回傳值有誤: req = ${e}, res = `+r.body.getUint8(0));return _.times(4,e=>this.toHexZerofill(r.body.getUint8(e+1),2)).join("")},async bleGetTimestampV2(e){if(!_.inRange(e,0,3))throw new Error("channel 必須介於 0 到 2 之間");const t=this.bleNewRequest25({cmd:84,len:1}),r=(t.body.setUint8(0,e),await this.bleSendRequest({req:t}));if(!r.body.getUint8(r.len-1))throw new Error("timestamp 讀取失敗");if(r.body.getUint8(0)!==e)throw new Error(`channel 回傳值有誤: req = ${e}, res = `+r.body.getUint8(0));return _.times(8,e=>this.toHexZerofill(r.body.getUint8(e+1),2)).join("")},async bleGetModeV2(){var e=this.bleNewRequest25({cmd:85});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return _.times(5,e=>t.body.getUint8(e));throw new Error("mode 讀取失敗")},async bleGetBeacons(){const t={sn:await this.bleGetSn()};var r=await this.bleGetModeV2();for(let e=0;e<3;e++)t["hwid"+e]=await this.bleGetHwidV2(e),t["lotKey"+e]=await this.bleGetLotKeyV2(e),t["mode"+e]=_.get(r,e,0),t["timestamp"+e]=await this.bleGetTimestampV2(e),t["vendorKey"+e]=await this.bleGetVendorKeyV2(e);return t},async bleGetBatteryVoltage(){var e=this.bleNewRequest25({cmd:60});const t=await this.bleSendRequest({req:e});if(t.body.getUint8(t.len-1))return{voltage:t.body.getUint16(0),battery:t.body.getUint8(2)};throw new Error("battery voltage 讀取失敗")},async bleSetTxPower(e){if(!_.inRange(e,0,8))throw new Error("txPower 有誤");const t=this.bleNewRequest25({cmd:37,len:1}),r=(t.body.setUint8(0,e),await this.bleSendRequest({req:t}));if(!r.body.getUint8(r.len-1))throw new Error("txPower 設定失敗")},async bleSetAdvInterval(e){if(!_.isSafeInteger(e))throw new Error("advInterval 有誤");const t=this.bleNewRequest25({cmd:38,len:4}),r=(t.body.setUint32(0,e),await this.bleSendRequest({req:t}));if(!r.body.getUint8(r.len-1))throw new Error("advInterval 設定失敗")},async bleSetSn(e){if(!this.isValidSn(e))throw new Error("sn 有誤");e=e.replace(/^(.{7})(.{2})(.{4})$/,"$1_$2_$3");var t=this.bleNewRequest25({cmd:39,len:15});new Uint8Array(t.buffer,2).set(new Uint8Array((new TextEncoder).encode(e).buffer));const r=await this.bleSendRequest({req:t});if(!r.body.getUint8(r.len-1))throw new Error("sn 設定失敗")},async bleSetHwidV1(e){if(!_.isString(e)||10!==e.length)throw new Error("hwid 有誤");const r=this.bleNewRequest25({cmd:40,len:e.length/2}),t=(_.each(e.match(/.{2}/g),(e,t)=>r.body.setUint8(t,_.parseInt(e,16))),await this.bleSendRequest({req:r}));if(!t.body.getUint8(t.len-1))throw new Error("hwid 設定失敗")},async bleSetLotKeyV1(e){if(!_.isString(e)||16!==e.length)throw new Error("lotKey 有誤");const r=this.bleNewRequest25({cmd:41,len:e.length/2}),t=(_.each(e.match(/.{2}/g),(e,t)=>r.body.setUint8(t,_.parseInt(e,16))),await this.bleSendRequest({req:r}));if(!t.body.getUint8(t.len-1))throw new Error("lotKey 設定失敗")},async bleSetVendorKeyV1(e){if(!_.isString(e)||8!==e.length)throw new Error("vendorKey 有誤");const r=this.bleNewRequest25({cmd:42,len:e.length/2}),t=(_.each(e.match(/.{2}/g),(e,t)=>r.body.setUint8(t,_.parseInt(e,16))),await this.bleSendRequest({req:r}));if(!t.body.getUint8(t.len-1))throw new Error("vendorKey 設定失敗")},async bleSetModeV1(e){if(!_.inRange(e,0,3))throw new Error("mode 有誤");const t=this.bleNewRequest25({cmd:45,len:4}),r=(t.body.setUint32(0,e),await this.bleSendRequest({req:t}));if(!r.body.getUint8(r.len-1))throw new Error("mode 設定失敗")},async bleSetHwidV2(e,t){if(!_.inRange(e,0,3))throw new Error("channel 必須介於 0 到 2 之間");if(!_.isString(t)||10!==t.length)throw new Error("hwid 有誤");const r=this.bleNewRequest25({cmd:65,len:1+t.length/2}),i=(r.body.setUint8(0,e),_.each(t.match(/.{2}/g),(e,t)=>r.body.setUint8(t+1,_.parseInt(e,16))),await this.bleSendRequest({req:r}));if(!i.body.getUint8(i.len-1))throw new Error("hwid 設定失敗")},async bleSetLotKeyV2(e,t){if(!_.inRange(e,0,3))throw new Error("channel 必須介於 0 到 2 之間");if(!_.isString(t)||16!==t.length)throw new Error("lotKey 有誤");const r=this.bleNewRequest25({cmd:66,len:1+t.length/2}),i=(r.body.setUint8(0,e),_.each(t.match(/.{2}/g),(e,t)=>r.body.setUint8(t+1,_.parseInt(e,16))),await this.bleSendRequest({req:r}));if(!i.body.getUint8(i.len-1))throw new Error("lotKey 設定失敗")},async bleSetVendorKeyV2(e,t){if(!_.inRange(e,0,3))throw new Error("channel 必須介於 0 到 2 之間");if(!_.isString(t)||8!==t.length)throw new Error("vendorKey 有誤");const r=this.bleNewRequest25({cmd:67,len:1+t.length/2}),i=(r.body.setUint8(0,e),_.each(t.match(/.{2}/g),(e,t)=>r.body.setUint8(t+1,_.parseInt(e,16))),await this.bleSendRequest({req:r}));if(!i.body.getUint8(i.len-1))throw new Error("vendorKey 設定失敗")},async bleSetTimestampV2(e,t){if(!_.inRange(e,0,3))throw new Error("channel 必須介於 0 到 2 之間");if(!_.isString(t)||16!==t.length)throw new Error("timestamp 有誤");const r=this.bleNewRequest25({cmd:68,len:1+t.length/2}),i=(r.body.setUint8(0,e),_.each(t.match(/.{2}/g),(e,t)=>r.body.setUint8(t+1,_.parseInt(e,16))),await this.bleSendRequest({req:r}));if(!i.body.getUint8(i.len-1))throw new Error("timestamp 設定失敗")},async bleSetModeV2(e){if(!_.isArray(e)||5!==e.length)throw new Error("modes 有誤");const r=this.bleNewRequest25({cmd:69,len:e.length}),t=(_.each(e,(e,t)=>{if(!_.inRange(e,0,3))throw new Error(`modes[${t}] 必須介於 0 到 2 之間`);r.body.setUint8(t,e)}),await this.bleSendRequest({req:r}));if(!t.body.getUint8(t.len-1))throw new Error("modes 設定失敗")},async bleSetBeacons(t){await this.bleSetSn(t.sn);const r=Array(5).fill(0);for(let e=0;e<3;e++)await this.bleSetHwidV2(e,t["hwid"+e]),await this.bleSetLotKeyV2(e,t["lotKey"+e]),await this.bleSetTimestampV2(e,t["timestamp"+e]),await this.bleSetVendorKeyV2(e,t["vendorKey"+e]),r[e]=t["mode"+e];await this.bleSetModeV2(r)},isValidSn(e){return _.isString(e)&&13===e.length},async getBluetoothAvailability(){return _.invoke(navigator,"bluetooth.getAvailability")},async bleSearchDevice(){if(!this.device){if(!await this.getBluetoothAvailability())throw new Error("您的裝置不支援藍芽功能");if(this.device=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"LE_"},{services:[this.uuidService]}]}),!this.device)throw new Error("未選擇裝置");this.logTime(`裝置選擇成功, name = ${this.device.name}, id = `+this.device.id)}},async bleEnsureConnected(){var t=()=>_.get(this,"device.gatt.connected");if(!t()){var{uuidService:e,uuidWrite:r,uuidNotify:i}=this;await this.bleSearchDevice();for(let e=0;!t()&&e<3;e++)try{this.logTime(`嘗試連線至裝置 (第 ${e+1} 次)`),await this.device.gatt.connect(),await sleep(500)}catch(e){console.error(e)}if(!t())throw new Error("裝置連線失敗");this.device.addEventListener("gattserverdisconnected",this.bleOnDisconnect),this.bleService=await this.device.gatt.getPrimaryService(e),this.bleCharWrite=await this.bleService.getCharacteristic(r),this.bleCharNotify=await this.bleService.getCharacteristic(i),this.bleCharNotify.addEventListener("characteristicvaluechanged",this.bleOnNotify),await this.bleCharNotify.startNotifications(),this.logTime("裝置連線成功")}},async bleDisconnect(){this.device&&(this.device.gatt.disconnect(),this.device=null)},async bleOnDisconnect(){this.logTime("裝置斷線"),this.otaEntered=0,this.bleCharNotify&&(this.bleCharNotify.removeEventListener("characteristicvaluechanged",this.bleOnNotify),this.bleCharNotify=null),this.bleCharWrite&&(this.bleCharWrite=null),this.bleService&&(this.bleService=null),this.device&&(this.device.removeEventListener("gattserverdisconnected",this.bleOnDisconnect),_.get(this,"device.gatt.connected")&&this.device.gatt.disconnect())},getBeaconRegisterUrl(e){var t=this.h.secret;if(!t)return"#";e=JSON.stringify({hwid:e});return"https://lihi1.com/fHbeb/"+(window.encodeBase64url(e)+"."+window.hs256Base64url(e,t))},bleOnNotify:(()=>{const o={8:e=>{if(e.len=16383&e.frame.getUint16(1,!0),e.body=new DataView(e.buffer,4),e.len!==e.body.byteLength)throw new Error(`回傳資料長度有誤: len = ${e.len}, body.length = `+e.body.byteLength);return e},38:e=>(e.len=e.buffer.byteLength-3,e.body=new DataView(e.buffer,2,e.len),e)};return async function(e){var t="pending.bleSendRequest",e=_.get(e,"target.value.buffer");this.logTime("收到回應 "+this.inspectBuffer(e));const r={buffer:e,frame:new DataView(e)};try{var i=r.frame.getUint8(0);const n=_.get(o,i);if(!_.isFunction(n))throw new Error("未知的 SOF: "+i);_.invoke(window,t+".resolve",n(r))}catch(e){e.response=r,this.logTime(e.message),_.invoke(window,t+".reject",e)}}})(),async bleSendRequest({req:t,timeout:e=3e3,verbose:r=!0}){if(!(_.get(t,"buffer")instanceof ArrayBuffer))throw new Error("invalid req.buffer");if(!(_.get(t,"frame")instanceof DataView))throw new Error("invalid req.frame");const i="pending.bleSendRequest";if(await this.bleEnsureConnected(),!this.otaEntered&&37===t.frame.getUint8(0)&&59!==t.frame.getUint8(1)){var n=await this.bleGetFirmwareVersion();if(n!==this.model+"_"+this.version)throw new Error("韌體版本有誤: "+n);for(let e=1;e<3;e++)await this.bleGetFirmwareVersion();this.otaEntered=1}r&&this.logTime("正在送出指令 "+this.inspectBuffer(t.buffer));try{return await Promise.race([(async()=>{throw await sleep(e),new Error(`無回應 (${e}ms)`)})(),(async()=>{if(_.get(window,i))throw new Error("有其他 BLE 指令正在執行");var e=t.ack?new Promise((e,t)=>_.set(window,i,{resolve:e,reject:t})):null;return await this.bleCharWrite.writeValue(t.buffer),e})()])}finally{_.set(window,i,null)}},inspectBuffer(e){return e=ArrayBuffer.isView(e)?e.buffer:e,_.join(_.map(new Uint8Array(e),e=>this.toHexZerofill(e,2))," ")},toHexZerofill(e,t){return _.padStart(e.toString(16),t,"0")},logTime(e){console.log(`[${dayjs().format("HH:mm:ss.SSS")}] `+e)},showLoading(e,t){Swal.fire({title:e,text:t,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}})}}});</script></body></html>