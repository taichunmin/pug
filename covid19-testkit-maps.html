<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>COVID-19 快篩實名制地圖</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><meta content="顯示附近藥局，方便您前往購買 COVID-19 快篩試劑！" name="description"><meta content="2133031763635285" property="fb:app_id"><meta content="顯示附近藥局，方便您前往購買 COVID-19 快篩試劑！" property="og:description"><meta content="https://i.imgur.com/O9GX9P9.png" property="og:image"><meta content="600" property="og:image:height"><meta content="1200" property="og:image:width"><meta content="zh_TW" property="og:locale"><meta content="筆記國度" property="og:site_name"><meta content="COVID-19 快篩實名制地圖" property="og:title"><meta content="website" property="og:type"><meta content="https://taichunmin.idv.tw/pug/covid19-testkit-maps.html" property="og:url"><link href="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0/dist/L.Control.Locate.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1/dist/MarkerCluster.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1/dist/MarkerCluster.Default.css" rel="stylesheet"><style>[v-cloak]{display:none}#app,body,html{height:100%;width:100vw}.leaflet-popup-content{font-size:14px}.leaflet-popup-content h6{font-size:18px;margin-bottom:1rem}.leaflet-popup-content .table-store th{white-space:nowrap}.leaflet-popup-content .table-store td{text-align:right}.leaflet-popup-content .table-time th{background-color:#d6d8db}</style></head><body><div id="app" v-cloak></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/joi@17/dist/joi-browser.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0/dist/L.Control.Locate.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1/dist/leaflet.markercluster.min.js" crossorigin="anonymous"></script><script>const Joi=window["joi"],vm=(window.sleep=e=>new Promise(t=>setTimeout(t,e)),new Vue({el:"#app",data:{h:{lastNews:""}},async mounted(){try{var t=JSON5.parse(localStorage.getItem(location.pathname));t&&this.$set(this,"h",{...this.h,...t})}catch(t){}this.$watch("h",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.h))},{deep:!0}),await this.init()},methods:{async init(){try{this.initMap(),this.showLoading("讀取中","COVID-19 快篩實名制地圖");var[t,e,a]=await Promise.all([this.fetchOpens(),this.fetchStores(),this.fetchStores0430()]);await this.renderMap({opens:t,stores:e,stores0430:a}),await window.sleep(100),Swal.close(),await this.showNews()}catch(t){console.error(t),await Swal.fire({icon:"error",title:"發生錯誤",text:t.message}),location.reload()}},async showNews(){var t,e="2022/09/01";this.h.lastNews!==e&&(t=await Swal.fire({cancelButtonText:"與開發者聯絡",confirmButtonText:"我知道了",imageUrl:"https://i.imgur.com/oGxIa81.jpeg",reverseButtons:!0,showCancelButton:!0,customClass:{htmlContainer:"mx-0",image:"my-0"}}),this.h.lastNews=e,t.value||(location.href="https://fb.me/taichunmin"))},async initMap(){var t;window.map||(t=L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attribution">CARTO</a>'}),t=window.map=L.map("app",{center:[25.040857,121.567904],layers:[t],tap:!1,zoom:15}),window.lc=L.control.locate({initialZoomLevel:15,position:"topleft",strings:{title:"取得手機定位",popup:"您目前的位置"}}).addTo(t))},async fetchOpens(){var t=await this.getCsv("https://taichunmin.idv.tw/covid19-testkit-maps-crawler/opens.csv");const e=new Map;for(const a of t)e.set(a.id,a.time);return e},async fetchStores(){var t=await this.getCsv("https://data.nhi.gov.tw/resource/Nhi_Fst/Fstdata.csv");const e=new Map,a=Joi.object({addr:Joi.string().trim().required(),amount:Joi.number().integer().min(0).required(),id:Joi.string().alphanum().required(),lat:Joi.number().min(21).max(28).empty("0").required(),lng:Joi.number().min(117).max(123).empty("0").required(),name:Joi.string().trim().required(),notice:Joi.string().trim().empty(Joi.any().equal("-","")).default(""),tel:Joi.string().trim().required(),testkit:Joi.string().trim().required(),updatedAt:Joi.any().required()});var o=_.zipObject("０１２３４５６７８９／：；（）～〜。\n".split(""),"0123456789/:;()~~;;".split(""));let r=0;for(const s of t)try{const i=dayjs(s["來源資料時間"],"YYYY/MM/DD HH:mm:ssZZ");if(!i.isValid())throw new Error("時間錯誤");const n=await a.validateAsync({addr:s["醫事機構地址"],amount:s["快篩試劑截至目前結餘存貨數量"],id:s["醫事機構代碼"],lat:s["緯度"],lng:s["經度"],name:s["醫事機構名稱"],notice:s["備註"],tel:s["醫事機構電話"],testkit:s["廠牌項目"],updatedAt:i.format("MM/DD HH:mm")},{stripUnknown:!0});for(const c of["addr","notice","tel"])n[c]=((t,e)=>_.map(t,t=>_.get(e,[t],t)).join(""))(n[c],o);e.set(n.id,n)}catch(t){r++,(window.errStores=window.errStores||[]).push({...s,message:t.message})}return r&&console.log(`fetchStores 有 ${r} 筆錯誤資料`),e},async fetchStores0430(){var t=await this.getCsv("https://taichunmin.idv.tw/covid19-testkit-maps-crawler/stores0430.csv");const e=new Map;for(const a of t)e.set(a.id,{..._.pick(a,["addr","id","lat","lng","name","notice","tel","testkit"]),amount:0,max:a.amount});return e},async renderMap({opens:t,stores:e,stores0430:a}){console.log({opens:t,stores:e,stores0430:a});const o=window["map"],r=L.Icon.extend({options:{iconAnchor:[18,36],iconSize:[36,36],popupAnchor:[0,-38]}});var s={green:new r({iconUrl:"https://i.imgur.com/1KRTaAO.png"}),red:new r({iconUrl:"https://i.imgur.com/Ed6iMMC.png"}),unknown:new r({iconUrl:"https://i.imgur.com/mfATTxs.png"}),yellow:new r({iconUrl:"https://i.imgur.com/raxi9vh.png"})};const i=t=>{var e,t={api:1,destination:t.lat+","+t.lng,openExternalBrowser:1,travelmode:"walking"};return"https://www.google.com/maps/dir/?"+(e={},Qs.stringify(t,{arrayFormat:"brackets",...e}))},n=a=>{const t=["<tr><th>　</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th><th>日</th></tr>"];var o=["上","下","晚"];for(let e=0;e<3;e++){const r=[`<th>${o[e]}</th>`];for(let t=0;t<7;t++)"1"===a[7*e+t]?r.push('<td class="table-success"><i class="fa fa-check"></i></td>'):r.push('<td class="table-danger"><i class="fa fa-times"></i></td>');t.push("<tr>"+r.join("")+"</tr>")}return t.join("")},c=t=>"tel:"+t.replace(/^[(]*(\d+)[)\s-]*(\d+)$/,"$1-$2");var l=(t,e)=>L.marker([t.lat,t.lng],{icon:e}).bindPopup((t=>`<h6>${t.name}</h6>`+'<table class="table table-sm mb-2 table-borderless table-store text-monospace">'+`<tr><th class="text-right" colspan="2">${t.testkit}</th></tr>`+`<tr><th>數量</th><td>${t.max?t.amount+" / "+t.max:t.amount}</td></tr>`+`<tr><th>電話</th><td><a href="${c(t.tel)}">${t.tel}</a></td></tr>`+`<tr><th>備註</th><td>${t.notice}</td></tr>`+`<tr><th>地址</th><td>${t.addr}</td></tr>`+`<tr><th>更新</th><td>${t.updatedAt}</td></tr>`+"</table>"+(t.open?`<table class="table table-sm mb-2 table-bordered text-center table-time">${n(t.open)}</table>`:"")+`<a class="btn btn-dark btn-block text-white mt-3" href="${i(t)}" role="button" target="_blank">`+"Google 導航</a>")(t),{minWidth:200});const h=L.markerClusterGroup({chunkedLoading:!0,disableClusteringAtZoom:15,spiderfyOnMaxZoom:!1});for(const d of _.uniq([...e.keys(),...a.keys()])){const m={...a.get(d),...e.get(d),open:t.get(d)};m.amount=m.amount||0,m.updatedAt=m.updatedAt||"?",_.toSafeInteger(m.max)<0?h.addLayer(l(m,s.unknown)):m.amount?h.addLayer(l(m,m.amount<.2*m.max?s.yellow:s.green)):h.addLayer(l(m,s.red))}o.addLayer(h),window.lc.start()},async getCsv(t,e=3e4){t=_.trim(_.get(await axios.get(t,{params:{cachebust:_.floor(Date.now()/e)}}),"data"));return _.get(Papa.parse(t,{encoding:"utf8",header:!0}),"data",[])},showLoading(t,e){Swal.fire({title:t,text:e,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>Swal.showLoading()})}}}));</script></body></html>