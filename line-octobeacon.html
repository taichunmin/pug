<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>Octobeacon 設定</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><meta content="2133031763635285" property="fb:app_id"><meta content="設定 Octobeacon 的工具程式" property="og:description"><meta content="zh_TW" property="og:locale"><meta content="筆記國度" property="og:site_name"><meta content="Octobeacon 設定" property="og:title"><meta content="website" property="og:type"><meta content="https://taichunmin.idv.tw/pug/line-octobeacon.html" property="og:url"><style>[v-cloak]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,body,h1,h2,h3,h4,h5,h6{font-family:"Noto Sans TC",sans-serif}.card-beacon .input-group-sm .input-group-text{letter-spacing:-1px;min-width:6rem}</style></head><body><div class="container-fluid my-3" id="app" v-cloak><h3 class="mb-3 text-center">Octobeacon 設定</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3"><div class="col mb-4"><div class="card"><div class="card-body text-monospace"><h5 class="card-title">操作</h5><p class="card-text">本程式目前支援在 Windows、macOS 及 Android 6.0 以上的 Chrome 中執行，請開啟定位以及藍牙。</p><div class="row row-cols-1 row-cols-md-2 mx-n1"><div class="col px-1"><button @click="btnRead" class="mt-2 btn btn-block btn-outline-success" type="button"><span class="fa fa-fw fa-download"></span> 讀取 Beacon</button></div><div class="col px-1"><button @click="btnWrite" class="mt-2 btn btn-block btn-outline-primary" type="button"><span class="fa fa-fw fa-upload"></span> 寫入 Beacon</button></div><div class="col px-1"><button @click="btnDevice" class="mt-2 btn btn-block btn-outline-info" type="button"><span class="fa fa-fw fa-bluetooth"></span> 選擇 Beacon</button></div><div class="col px-1"><button @click="btnReset" class="mt-2 btn btn-block btn-outline-danger" type="button"><span class="fa fa-fw fa-trash-o"></span> 清除資料</button></div></div></div></div></div><div class="col mb-4" v-for="bc, bcNo in i.beacons"><div class="card card-beacon"><div class="card-body text-monospace"><div class="card-title d-flex justify-content-between"><h5>LINE Beacon {{ bcNo + 1 }}</h5><div class="custom-control custom-switch"><input class="custom-control-input" v-model="bc.enabled" :id="`bc${bcNo}-enabled`" type="checkbox"><label :for="`bc${bcNo}-enabled`" class="custom-control-label">啟用</label></div></div><div class="was-validated"><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">offset(16)</span></div><input class="form-control text-right" v-model="bc.offset" inputmode="email" maxlength="16" pattern="[0-9a-fA-F]{16}" required></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">hwid(10)</span></div><input class="form-control text-right" v-model="bc.hwid" inputmode="email" maxlength="10" pattern="[0-9a-fA-F]{10}" required></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">vendor(8)</span></div><input class="form-control text-right" v-model="bc.vendor" inputmode="email" maxlength="8" pattern="[0-9a-fA-F]{8}" required></div><div class="mt-2 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">lot(16)</span></div><input class="form-control text-right" v-model="bc.lot" inputmode="email" maxlength="16" pattern="[0-9a-fA-F]{16}" required></div></div></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script>const sleep=e=>new Promise(t=>{setTimeout(t,e)});window.vm=new Vue({el:"#app",data:{device:null,i:{beacons:null}},async mounted(){try{var t=JSON5.parse(localStorage.getItem(location.pathname));t&&this.$set(this,"i",{...this.i,...t})}catch(t){}this.$watch("i",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.i))},{deep:!0}),this.i.beacons||await this.btnReset(!1)},methods:{async getBluetoothAvailability(){return _.invoke(navigator,"bluetooth.getAvailability")},async btnReset(t=!0){t&&!(t=await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"保持原樣",confirmButtonColor:"#d33",confirmButtonText:"重設紀錄",focusCancel:!0,icon:"warning",showCancelButton:!0,text:"是否重設本頁面的紀錄？"})).value||this.$set(this.i,"beacons",_.times(8,()=>({enabled:!1,offset:_.padStart("",16,"0"),hwid:_.padStart("",10,"0"),vendor:_.padStart("",8,"0"),lot:_.padStart("",16,"0")})))},async bleGetDevice(){if(!await this.getBluetoothAvailability())throw new Error("您的裝置不支援藍芽功能");var t=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"Octobeacon",services:["89798198-0000-0000-0000-000000000000"]}]});if(t)return await sleep(100),t;throw new Error("未選擇裝置")},async btnDevice(){try{this.showLoading("請稍候","選擇裝置中…"),this.device=await this.bleGetDevice(),await Swal.fire({icon:"success",title:"裝置選擇成功"})}catch(t){console.error(t),await Swal.fire({icon:"error",title:"裝置選擇失敗",text:t.message})}},async btnRead(){try{this.showLoading("請稍候","從裝置讀取中…"),this.device||(this.device=await this.bleGetDevice()),await this.device.gatt.connect();const t=await this.device.gatt.getPrimaryService("89798198-0000-0000-0000-000000000000"),e=await t.getCharacteristic("89798198-249d-48bd-894e-db156f1a70e6");this.settingParse(await e.readValue()),this.device.gatt.disconnect(),await sleep(500),await Swal.fire({icon:"success",title:"從裝置讀取成功"})}catch(t){console.error(t),await Swal.fire({icon:"error",title:"從裝置讀取失敗",text:t.message})}},async btnWrite(){try{this.showLoading("請稍候","上傳到裝置中…");var t=this.settingStringify();this.device||(this.device=await this.bleGetDevice()),await this.device.gatt.connect();const e=await this.device.gatt.getPrimaryService("89798198-0000-0000-0000-000000000000"),i=await e.getCharacteristic("89798198-249d-48bd-894e-db156f1a70e6");await i.writeValue(t.buffer),this.device.gatt.disconnect(),await sleep(500),await Swal.fire({icon:"success",title:"上傳到裝置成功"})}catch(t){console.error(t),await Swal.fire({icon:"error",title:"上傳到裝置失敗",text:t.message})}},showLoading(t,e){Swal.fire({title:t,text:e,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}})},settingParse(e){if(console.log("settingParse: ",e),210!==_.get(e,"byteLength",0))throw new Error("尚未進入工程模式");var t=e.getUint8(0);if(1!==t)throw new Error(`version should be 1, received ${t}.`);const i=_.padStart(e.getUint8(1).toString(2),8,"0"),a=e.getBigUint64(2,!0);t=_.times(8,t=>({enabled:"1"===i[t],offset:_.padStart((e.getBigUint64(25*t+10,!0)+a).toString(16),16,"0"),hwid:this.dvGetHex(e,25*t+18,5),vendor:this.dvGetHex(e,25*t+23,4),lot:this.dvGetHex(e,25*t+27,8)}));this.$set(this.i,"beacons",t)},settingStringify(){const e=new DataView(new ArrayBuffer(210));var i=this.i.beacons;e.setUint8(0,1),e.setUint8(1,_.parseInt(_.map(i,t=>"01"[+t.enabled]).join(""),2)),e.setBigUint64(2,BigInt(0),!0);for(let t=0;t<8;t++){var a=i[t];if(!/^[0-9a-fA-F]{16}$/.test(a.offset))throw new Error(`beacon[${t}].offset 資料格式有誤`);if(!/^[0-9a-fA-F]{10}$/.test(a.hwid))throw new Error(`beacon[${t}].hwid 資料格式有誤`);if(!/^[0-9a-fA-F]{8}$/.test(a.vendor))throw new Error(`beacon[${t}].vendor 資料格式有誤`);if(!/^[0-9a-fA-F]{16}$/.test(a.lot))throw new Error(`beacon[${t}].lot 資料格式有誤`);e.setBigUint64(25*t+10,BigInt("0x"+a.offset),!0),this.dvSetHex(e,25*t+18,""+a.hwid+a.vendor+a.lot)}return console.log("settingStringify: ",e),e},dvGetHex(t,e,i){return _.map(new Uint8Array(t.buffer,e,i),t=>("0"+t.toString(16)).slice(-2)).join("")},dvSetHex(t,e,i){if(!_.isString(i)||!i.length||i.length%2)throw new Error("錯誤的 hex");new Uint8Array(t.buffer,e).set(new Uint8Array(_.map(i.match(/.{2}/g),t=>_.parseInt(t,16))))}}});</script></body></html>