<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>LINE Notify 大量發送工具</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><meta content="2133031763635285" property="fb:app_id"><meta content="LINE Notify 大量發送工具" property="og:description"><meta content="zh_TW" property="og:locale"><meta content="筆記國度" property="og:site_name"><meta content="LINE Notify 大量發送工具" property="og:title"><meta content="website" property="og:type"><meta content="https://liff.line.me/1654046335-L8mO8BYy" property="og:url"><style>[v-cloak]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,body,h1,h2,h3,h4,h5,h6{font-family:"Noto Sans TC",sans-serif}.input-group-prepend .input-group-text{letter-spacing:-1px;min-width:5rem}</style></head><body><div class="container-fluid my-3" id="app" v-cloak><h3 class="mb-3 text-center">LINE Notify 大量發送工具</h3><div class="text-monospace was-validated"><div class="input-group input-group-sm mb-2"><div class="input-group-prepend"><span class="input-group-text justify-content-end">資料 CSV</span></div><textarea class="form-control" inputmode="url" pattern="https://[^/?#]+[^?#]*(\?[^#]*)?(#.*)?" required v-model="h.csv"></textarea></div><div class="input-group input-group-sm mb-2"><div class="input-group-prepend"><span class="input-group-text justify-content-end">token</span></div><input class="form-control" inputmode="url" pattern=".+" required v-model="h.token"></div><div class="mb-2 card" :key="msgNo" v-for="msg, msgNo in h.msgs"><div class="text-monospace card-body"><div class="align-items-start card-title d-flex justify-content-between mb-0"><h5>第 {{ msgNo + 1 }} 筆訊息</h5><button @click="btnDel(msgNo)" class="btn btn-outline-danger btn-sm py-0" type="button"><span class="fa fa-fw fa-trash-o"></span>刪除</button></div><small class="text-muted">所有欄位均可使用 <code>_.template</code> 的語法，CSV 中讀取的資料會存在 <code>${row}</code> 變數中。</small><div class="mt-2 mx-n1 row"><div class="col px-1"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">package</span></div><input class="form-control" inputmode="url" pattern=".+" required v-model="msg.stickerPackageId"></div></div><div class="col px-1"><div class="input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-end">sticker</span></div><input class="form-control" inputmode="url" pattern=".+" required v-model="msg.stickerId"></div></div></div><div class="input-group input-group-sm mt-2"><div class="input-group-prepend"><span class="input-group-text justify-content-end">圖片網址</span></div><textarea class="form-control" inputmode="url" pattern=".+" required v-model="msg.imageFullsize"></textarea></div><div class="input-group input-group-sm mt-2"><div class="input-group-prepend"><span class="input-group-text justify-content-end">縮圖網址</span></div><textarea class="form-control" inputmode="url" pattern=".+" required v-model="msg.imageThumbnail"></textarea></div><div class="input-group input-group-sm mt-2"><div class="input-group-prepend"><span class="input-group-text justify-content-end">訊息內容</span></div><textarea class="form-control" inputmode="url" pattern=".+" required v-model="msg.message" rows="10"></textarea></div></div></div><div class="row mx-n2"><button @click="btnAdd" class="btn mx-2 my-1 btn-info" type="button">新增一筆訊息</button><button @click="btnShare" class="btn mx-2 my-1 btn-success" type="button">分享測試訊息</button><button @click="btnSend" class="btn mx-2 my-1 btn-danger" type="button">推送訊息</button><a class="btn mx-2 my-1 btn-outline-info" href="https://line.me/R/ti/p/@736cebrk" target="_blank">查 Sticker 的 ID</a><a class="btn mx-2 my-1 btn-outline-info" href="https://notify-bot.line.me/doc/en/" target="_blank">Notify 文件</a><a class="btn mx-2 my-1 btn-outline-info" href="https://lodash.com/docs/#template" target="_blank">訊息變數教學</a><a class="btn mx-2 my-1 btn-outline-info" href="https://developers.line.biz/en/docs/messaging-api/sticker-list/" target="_blank">Sticker 清單</a><a class="btn mx-2 my-1 btn-outline-info" href="https://mybrowseraddon.com/access-control-allow-origin.html" target="_blank">CORS 擴充套件</a></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/joi@17/dist/joi-browser.min.js" crossorigin="anonymous"></script><script src="https://static.line-scdn.net/liff/edge/2/sdk.js" crossorigin="anonymous"></script><script>const loginPromise=(async()=>{if(await liff.init({liffId:"1654046335-L8mO8BYy"}),!liff.isLoggedIn())return liff.login({redirectUri:location.href}),new Promise(t=>{});var t=await liff.getProfile().catch(()=>({}));if(t.userId)return window.gtagSetLineId&&window.gtagSetLineId(t.userId),t;throw new Error("無法取得 userId")})();window.sleep=e=>new Promise(t=>setTimeout(t,e)),window.httpBuildQuery=(t,e={})=>Qs.stringify(t,{arrayFormat:"brackets",...e}),window.joiCustomUrl=(t,e)=>{t=new URL(t);if(/^https?:$/.test(t.protocol))return t.href;throw new TypeError("Protocol of URL should be http/https")},window.joiToken=(()=>{const e=joi.string().regex(/^[0-9A-Za-z]{43,}$/).empty("").required(),s={abortEarly:!1,stripUnknown:!0};return t=>e.validateAsync(t,s)})(),window.joiMsg=(t=>{const e=t.object({imageFullsize:t.string().trim().custom(window.joiCustomUrl).empty("").optional(),imageThumbnail:t.string().trim().custom(window.joiCustomUrl).empty("").optional(),message:t.string().min(1).max(1e3).required(),stickerId:t.number().integer().min(1).empty("").optional(),stickerPackageId:t.number().integer().min(1).empty("").optional()}).and("imageFullsize","imageThumbnail").and("stickerId","stickerPackageId"),s={abortEarly:!1,stripUnknown:!0};return t=>e.validateAsync(t,s)})(joi),window.vm=new Vue({el:"#app",data:{h:{token:"${row.token}",csv:"",msgs:null}},async mounted(){try{var t=JSON5.parse(localStorage.getItem(location.pathname));t&&this.$set(this,"h",{...this.h,...t})}catch(t){}this.$watch("h",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.h))},{deep:!0}),_.get(this,"h.msgs.length",0)||await this.btnAdd()},methods:{async btnAdd(){_.get(this,"h.msgs")||this.$set(this.h,"msgs",[]),this.h.msgs.push({imageFullsize:"${row.image}",imageThumbnail:"${row.thumbnail}",message:"${row.message}",stickerId:"${row.sticker}",stickerPackageId:"${row.package}"})},async btnDel(t){(await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"取消",confirmButtonColor:"#d33",confirmButtonText:"刪除",focusCancel:!0,icon:"warning",showCancelButton:!0,text:`是否刪除第 ${t+1} 筆訊息？`})).value&&this.h.msgs.splice(t,1)},async btnSend(){try{this.showLoading("訊息推送中","讀取 CSV 資料");const l=await this.getCsv(this.h.csv);if(!l.length)throw new Error("CSV 中沒有資料");if(!(await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"取消",confirmButtonColor:"#d33",confirmButtonText:"開始推送",icon:"question",showCancelButton:!0,text:`即將推送給 ${l.length} 個帳號`,title:"訊息推送確認"})).value)return;this.showLoading("訊息推送中","編譯訊息樣版");const c=this.compileTpl();let n=0;for(const t of _.chunk(_.toPairs(l),100))await Promise.all(_.map(t,async([e,t])=>{try{this.showLoading("訊息推送中",`編譯給帳號 (${_.parseInt(e)+1} / ${l.length}) 的訊息`);const r={Qs:Qs,_:_,dayjs:dayjs,row:t};var s,i,a=await window.joiToken(c.token(r)),o=await Promise.all(_.map(c.msgs,t=>window.joiMsg(_.mapValues(t,t=>t(r)))));for([s,i]of _.toPairs(o))this.showLoading("訊息推送中",`推送給帳號 (${_.parseInt(e)+1} / ${l.length})，訊息 (${_.parseInt(s)+1} / ${o.length})`),await this.apiNotify(a,i)}catch(t){t.message=`帳號 ${_.parseInt(e)+1} 發生錯誤: `+t.message,console.error(t),n++}})),await window.sleep(1e3);if(n)throw new Error(`累計發生 ${n} 個錯誤，請從開發者工具中查看錯誤。`);await Swal.fire({icon:"success",title:"訊息推送成功"})}catch(t){t.message=_.get(t,"response.data.message",t.message),console.error(t),await Swal.fire({icon:"error",title:"訊息推送失敗",text:t.message})}},async btnShare(){try{if(this.showLoading("分享測試訊息","初始化 LIFF"),await loginPromise,!liff.isApiAvailable("shareTargetPicker"))throw new Error("不支援 shareTargetPicker，請嘗試更新應用程式版本。");this.showLoading("分享測試訊息","讀取 CSV 資料");var t=await this.getCsv(this.h.csv);if(!t.length)throw new Error("CSV 中沒有資料");this.showLoading("分享測試訊息","編譯訊息樣版");var e=this.compileTpl();this.showLoading("分享測試訊息","編譯訊息");const n={Qs:Qs,_:_,dayjs:dayjs,row:_.first(t)};var s,i,a=await Promise.all(_.map(e.msgs,t=>window.joiMsg(_.mapValues(t,t=>t(n))))),o=_.chunk(_.flatten(_.map(a,this.notifyMsgToShareMsg)),5),r=(console.log("chunks =",JSON.stringify(o)),await Swal.fire({cancelButtonColor:"#3085d6",cancelButtonText:"取消",confirmButtonColor:"#d33",confirmButtonText:"開始分享",icon:"question",showCancelButton:!0,text:`接下來會有連續 ${o.length} 次分享`,title:"分享測試訊息"}));if(!r.value)return;for([s,i]of _.toPairs(o))if(this.showLoading("分享測試訊息",`分享 (${_.parseInt(s)+1} / ${o.length}) 次`),"success"!==_.get(await liff.shareTargetPicker(i),"status"))throw new Error("分享失敗");await Swal.fire({icon:"success",title:"訊息推送成功"})}catch(t){t.message=_.get(t,"response.data.message",t.message),console.error(t),await Swal.fire({icon:"error",title:"分享測試訊息失敗",text:t.message})}},async getCsv(t,e=3e4){t=_.trim(_.get(await axios.get(t,{params:{cachebust:_.floor(Date.now()/e)}}),"data"));return _.get(Papa.parse(t,{encoding:"utf8",header:!0}),"data",[])},async apiNotify(e,t){try{await axios.post("https://cors-anywhere-ybtjbo45iq-uc.a.run.app",window.httpBuildQuery(t),{headers:{Authorization:"Bearer "+e},params:{u:"https://notify-api.line.me/api/notify"}})}catch(t){throw t.message=_.get(t,"response.data.message",t.message),t.status=_.get(t,"response.status",500),401===t.status&&(t.message=`token 已失效 (${e})`),t}},compileTpl(){if(_.get(this,"h.msgs.length"))return{token:_.template(this.h.token),msgs:_.map(this.h.msgs,t=>_.mapValues(t,_.template))};throw new Error("請新增訊息")},notifyMsgToShareMsg(t){return[{type:"text",text:"【測試訊息】"+t.message},...t.stickerId?[{originalContentUrl:`https://stickershop.line-scdn.net/stickershop/v1/sticker/${t.stickerId}/android/sticker.png;compress=true`,previewImageUrl:`https://stickershop.line-scdn.net/stickershop/v1/sticker/${t.stickerId}/android/sticker.png;compress=true`,type:"image"}]:[],...t.imageFullsize&&t.imageThumbnail?[{originalContentUrl:t.imageFullsize,previewImageUrl:t.imageThumbnail,type:"image"}]:[]]},showLoading(t,e){Swal.fire({title:t,text:e,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}})}}});</script></body></html>