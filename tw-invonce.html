<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>電子發票證明聯</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><style>[v-cloak]{display:none}#inv{width:300px;border:2px solid #000;padding:28px}#inv .inv-header{font-weight:700}#inv .inv-header #seller{font-size:20px}#inv .inv-header #title{font-size:30px}#inv .inv-header #id,#inv .inv-header #peroid{font-size:35px;line-height:1.05}#inv .inv-body{font-size:.8rem}#inv #barcode-1d img{width:100%}#inv #barcode-2d{margin-top:20px}#inv #barcode-2d .qr{width:105px;display:inline-block}</style></head><body><div class="container-fluid my-3"><div id="inv" class="text-monospace"><div class="text-center inv-header"><div id="seller">公司名稱</div><div id="title">電子發票證明聯</div><div id="peroid"></div><div id="id"></div></div><div class="inv-body"><div id="date"></div><div class="row"><div class="col"><div id="check">隨機碼</div><div id="seller-id">賣方</div></div><div class="col"><div id="total-amount">總計</div><div id="buyer-id"></div></div></div></div><div id="barcode-1d" class="my-2"><img id="code39"></div><div id="barcode-2d" class="row text-center"><div class="col text-right"><div id="qr1" class="qr"></div></div><div class="col text-left"><div id="qr2" class="qr"></div></div></div></div></div><script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/joi@17/dist/joi-browser.min.js"></script><script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/bwip-js@2/dist/bwip-js.min.js"></script><script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/js-base64@2/base64.min.js"></script><script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js"></script><script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js"></script><script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/qrcode@1/build/qrcode.min.js"></script><script>const getQuery=(()=>{const t=new URL(location).searchParams;return e=>t.get(e)})(),domById=e=>window.document.getElementById(e),encodeBase64url=e=>Base64.encode(e).replaceAll(/[+/=]/g,e=>_.get({"+":"-","/":"_","=":""},e)),joiFn=(t,r)=>e=>t.validateAsync(e,r),pad0=(e,t)=>_.padStart(e,t,"0"),invChecker=joiFn(joi.object({buyerId:joi.string().regex(/^\d{8}$/).required(),check:joi.string().regex(/^\d{4}$/).required(),custom:joi.string().length(10).required(),date:joi.date().timestamp("unix").required(),encrypt:joi.string().base64({paddingRequired:!0}).length(24).required(),id:joi.string().regex(/^[A-Z]{2}\d{8}$/).required(),salesAmount:joi.number().integer().min(0).required(),seller:joi.string().required(),sellerId:joi.string().regex(/^\d{8}$/).required(),totalAmount:joi.number().integer().min(joi.ref("salesAmount")).required(),details:joi.array().items(joi.object({name:joi.string().required(),quantity:joi.number().integer().min(0).required(),price:joi.number().integer().min(0).required()}).required()).required()}),{stripUnknown:!0}),formatPeriod=e=>{let[t,r]=[e.year()-1911,e.month()+1];return r%2&&r++,`${t}年${pad0(r-1,2)}-${pad0(r,2)}月`},formatCode39=e=>{const t=e.date;var[r,o]=[t.year()-1911,t.month()+1],r=""+r+pad0(o+o%2,2)+e.id+e.check;const n=document.createElement("canvas");return bwipjs.toCanvas(n,{bcid:"code39",height:15,includecheck:!1,includetext:!1,text:r}),n.toDataURL("image/png")},formatQr=t=>{const r=[];return r.push(_.map(["id","date","check","salesAmount","totalAmount","buyerId","sellerId","encrypt"],e=>"date"===e?""+(t[e].year()-1911)+t[e].format("MMDD"):_.includes(["salesAmount","totalAmount"],e)?pad0(t[e].toString(16),8):t[e]).join("")),r.push(t.custom),r.push(t.details.length),r.push(t.details.length),r.push(1),_.each(t.details,e=>{r.push(`${e.name}:${e.quantity}:`+e.price)}),r.join(":")},textToQrSvg=(()=>{const t={version:6,errorCorrectionLevel:"L",margin:0};return e=>QRCode.toString(e,t)})();(async()=>{try{let e=getQuery("inv");if(!e)throw new Error("inv is required");(e=await invChecker(JSON.parse(Base64.decode(e)))).date=moment(e.date).utcOffset(8),console.log(e),domById("seller").textContent=e.seller,domById("peroid").textContent=formatPeriod(e.date),domById("id").textContent=e.id.replace(/^([A-Z]{2})/,"$1-"),domById("date").textContent=e.date.format("YYYY-MM-DD HH:mm:ss"),domById("check").textContent="隨機碼 "+e.check,domById("seller-id").textContent="賣方 "+e.sellerId,domById("total-amount").textContent="總計 "+e.totalAmount,"00000000"!==e.buyerId&&(domById("buyer-id").textContent="買方 "+e.buyerId),domById("code39").src=formatCode39(e),domById("qr1").innerHTML=await textToQrSvg(formatQr(e)),domById("qr2").innerHTML=await textToQrSvg("**")}catch(e){console.error(e)}})();</script></body></html>