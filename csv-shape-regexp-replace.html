<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>CSV 欄位資料文字形狀取代程式</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}#app .input-group-text{width:90px}#unmatch-shapes{font-size:12px}</style></head><body><div class="container text-monospace" id="app" v-cloak><h2 class="my-3">CSV 欄位資料文字形狀取代程式</h2><div class="mb-3 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">匯入資料</span></div><textarea class="form-control" inputmode="url" v-model="i.csvImport"></textarea></div><div class="mb-3 input-group input-group-sm"><div class="input-group-prepend"><span class="input-group-text justify-content-center">處理規則</span></div><select class="form-control" v-model="i.csvRules"><option value="https://docs.google.com/spreadsheets/d/e/2PACX-1vT8hVRMRBaRrSIoJrnGdh9X1OS28cWzRhAFuZfgUY-OWCDf_tv6U9i64Dt0HYiHbsVAyRneAfC2M4dB/pub?gid=0&single=true&output=csv">小型車平日第一小時臨停費用</option><option value="https://docs.google.com/spreadsheets/d/e/2PACX-1vT8hVRMRBaRrSIoJrnGdh9X1OS28cWzRhAFuZfgUY-OWCDf_tv6U9i64Dt0HYiHbsVAyRneAfC2M4dB/pub?gid=778840937&single=true&output=csv">市話手機免付費電話</option></select></div><div class="row"><div class="mb-3 input-group input-group-sm col"><div class="input-group-prepend"><span class="input-group-text justify-content-center">匯入欄位</span></div><input class="form-control" v-model="i.from"></div><div class="mb-3 input-group input-group-sm col"><div class="input-group-prepend"><span class="input-group-text justify-content-center">匯出欄位</span></div><input class="form-control" v-model="i.to"></div></div><button @click="btnUnmatch" class="mb-3 btn btn-sm btn-outline-primary" type="button">步驟 1: 尋找還沒有寫規則的文字形狀</button><button @click="btnExport" class="mb-3 btn btn-sm btn-outline-success ml-2" type="button">步驟 2: 匯出處理過的 CSV</button></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/moment@2/locale/zh-tw.min.js" crossorigin="anonymous"></script><script>const vm=new Vue({el:"#app",data:{parkings:[],ready:!1,rules:{},i:{csvImport:"",csvRules:"",from:"",to:""}},async mounted(){try{var t=JSON5.parse(localStorage.getItem(location.pathname));t&&this.$set(this,"i",{...this.i,...t})}catch(t){}this.$watch("i",()=>{localStorage.setItem(location.pathname,JSON5.stringify(this.i))},{deep:!0}),moment.locale("zh-tw"),this.ready=!0},computed:{allUnmatchShapes(){var t=_.groupBy(_.map(this.parkings,t=>{t=this.strNormalize(_.get(t,this.i.from));return{shape:this.strShape(t),from:t}}),"shape"),t=_.mapValues(t,t=>_.uniqBy(t,"from"));return _.omit(t,_.keys(this.rules))}},methods:{async btnUnmatch(){try{this.showLoading("載入中…","正在尋找還沒有寫規則的文字形狀"),this.validateInput(),await Promise.all([this.getCsvImport(),this.getCsvRules()]);var t=_.groupBy(_.map(this.parkings,t=>{t=this.strNormalize(_.get(t,this.i.from));return{shape:this.strShape(t),from:t}}),"shape"),e=_.map(_.omit(t,_.keys(this.rules)),(t,e)=>({shape:e,count:t.length,sample:_.first(t).from}));if(!e.length)return Swal.fire({icon:"success",title:"全部規則都建立過囉！"});var s=Papa.unparse(e,{header:!0}),r=this.strToBlobUrl(s,"text/csv");await this.showCsvUrl(`CSV 檔案中有 ${e.length} 筆紀錄`,r)}catch(t){console.error(t),Swal.fire({icon:"error",text:t.message,title:"發生錯誤"})}},async btnExport(){try{this.showLoading("載入中…","正在產生 CSV"),this.validateInput(),await Promise.all([this.getCsvImport(),this.getCsvRules()]);var t=_.map(this.parkings,t=>{var e=this.strNormalize(_.get(t,this.i.from)),s=_.get(this.rules,this.strShape(e));return{...t,[this.i.to]:this.strRuleReplace(e,s)}}),e=Papa.unparse(t,{header:!0}),s=this.strToBlobUrl(e,"text/csv");await this.showCsvUrl(`CSV 檔案中有 ${t.length} 筆紀錄`,s)}catch(t){console.error(t),Swal.fire({icon:"error",text:t.message,title:"發生錯誤"})}},async getCsvImport(){this.parkings=await this.getCsv("https://cors-anywhere.herokuapp.com/"+this.i.csvImport)},async getCsvRules(){var t=await this.getCsv("https://cors-anywhere.herokuapp.com/"+this.i.csvRules),t=_.filter(t,t=>t.pattern.length);t=_.map(t,t=>({...t,pattern:new RegExp(t.pattern)})),this.rules=_.keyBy(t,"shape")},async getCsv(t,e=3e4){t=_.trim(_.get(await axios.get(t,{params:{cachebust:_.floor(Date.now()/e)}}),"data"));return _.get(Papa.parse(t,{encoding:"utf8",header:!0}),"data",[])},async showCsvUrl(t,e){await Swal.fire({allowOutsideClick:!1,focusConfirm:!1,html:`<a class="btn btn-success" target="_blank" href="${e}" download="${moment().format("YYYY-MM-DD HHmmss")}.csv">請點此下載 CSV 檔案</a>`,icon:"success",title:t})},strToBlobUrl(t,e){t=new Blob([t],{type:e});return URL.createObjectURL(t)},validateInput(){_.each({csvImport:"匯入資料",csvRules:"處理規則",from:"匯入欄位",to:"匯出欄位"},(t,e)=>{if(!_.get(this.i,e))throw new Error(`「${t}」是必填欄位`)})},showLoading(t,e){Swal.fire({title:t,text:e,allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}})},hideLoading(){Swal.close()},strNormalize:(()=>{const r=_.zipObject("０１２３４５６７８９：；（）～〜。\n".split(""),"0123456789:;()~~;;".split(""));return t=>{return _.isString(t)?(t=_.trim(t),e=t,s=r,(t=(t=(t=(t=(t=_.map(e,t=>_.get(s,[t],t)).join("")).replaceAll(/,(\d{3})/g,"$1")).replaceAll(/(?<=\d)\s+(?=\d)/g,";")).replaceAll(/\s+/g,"")).replaceAll(/;+/g,";")).replaceAll(/;$/g,"")):"";var e,s}})(),strShape(t){return _.isString(t)?t.replaceAll(/\d/g,"0"):""},strRuleReplace(e,s){try{return _.isString(e)&&s?e.replace(s.pattern,s.replacement):""}catch(t){return console.log({str:e,rule:s,err:t}),""}}}});</script></body></html>