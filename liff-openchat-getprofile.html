<!doctype html><html><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"><title>在 Open Chat 執行 getProfile</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-39556213-3");</script><link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"><style>[v-cloak]{display:none}</style></head><body><div id="app" class="container my-4 text-monospace" v-cloak><div v-if="page === 'step1'" id="page-step1"><h1 class="my-3 text-center">Step 1</h1><p>請點選以下按鈕，讓程式可以順利呼叫 getProfile。</p><button @click="btnReloadWithoutContext" class="btn btn-block btn-primary" type="button">getProfile</button></div><div v-if="page === 'step2'" id="page-step2"><h1 class="my-3 text-center">Step 2</h1><p>成功呼叫 getProfile，接下來請回到 Open Chat 中再次開啟 LIFF。</p><button @click="btnClose" class="btn btn-block btn-primary" type="button">關閉頁面</button></div><div v-if="page === 'step3'" id="page-step3"><h1 class="my-3 text-center">Step 3</h1><p>成功從 localStorage 中取得 profile。</p><button @click="btnClearProfile" class="btn btn-block btn-danger" type="button">清除 profile</button></div><div v-if="page === 'error'" id="page-error"><h1 class="my-3 text-center">發生錯誤</h1></div><div v-if="context" class="my-3"><h4>context</h4><pre class="language-json" v-html="prismjs(JSON.stringify(context, null, 2))"></pre></div><div v-if="profile" class="my-3"><h4>profile</h4><pre class="language-json" v-html="prismjs(JSON.stringify(profile, null, 2))"></pre></div><div v-if="error" class="my-3"><h4>error</h4><pre class="language-json" v-html="prismjs(JSON.stringify(error, null, 2))"></pre></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-json.min.js" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vconsole/dist/vconsole.min.js" crossorigin="anonymous"></script><script src="https://static.line-scdn.net/liff/edge/2/sdk.js" crossorigin="anonymous"></script><script>const vConsole=new VConsole,errorToJson=(()=>{const e=["address","code","data","dest","errno","info","message","name","originalError.response.data","path","port","reason","response.data","response.headers","response.status","stack","status","statusCode","statusMessage","syscall"];return r=>_.transform(e,(e,t)=>{_.hasIn(r,t)&&_.set(e,t,_.get(r,t))},{})})(),vm=new Vue({el:"#app",data:{context:null,error:"",page:"",profile:null},async mounted(){try{if(alert(location.href),alert("localStorage keys = "+JSON.stringify(_.keys(localStorage),null,2)),alert("sessionStorage keys = "+JSON.stringify(_.keys(sessionStorage),null,2)),await liff.init({liffId:"1654046335-BWEQYWM1"}),this.context=liff.getContext(),"square_chat"===_.get(this,"context.type"))this.profile=this.getSavedProfile(),this.page=this.profile?"step3":"step1";else{if(!liff.isLoggedIn())return liff.login({redirectUri:location.href}),await new Promise(e=>{});this.profile=await liff.getProfile();var e=this.param("cid");if(!e)throw new Error("cid is required.");localStorage.setItem(e,JSON.stringify(this.profile)),this.page="step2"}}catch(e){this.handleError(e)}},methods:{getCid(){var e=_.get(this,"context.squareId"),t=_.get(this,"context.squareMemberId");if(e&&t)return e+"-"+t;throw new Error},getSavedProfile(){try{var e=this.getCid(),t=localStorage.getItem(e);return JSON.parse(t)}catch(e){return null}},param(e,t){e=new URL(location).searchParams.get(e);return _.isNil(e)?t:e},async btnReloadWithoutContext(){try{const e=new URL("https://liff.line.me/1654046335-BWEQYWM1/");return e.searchParams.set("cid",this.getCid()),location.href=e.href,await new Promise(e=>{})}catch(e){this.handleError(e)}},btnClose(){try{liff.closeWindow()}catch(e){Swal.fire({icon:"error",title:"發生錯誤",text:"請手動關閉頁面"})}},btnClearProfile(){try{var e=this.getCid();localStorage.removeItem(e),this.btnClose()}catch(e){this.handleError(e)}},handleError(e){this.page="error",this.error=errorToJson(e),console.error(e),Swal.fire({icon:"error",title:"發生錯誤",text:e.message})},prismjs(e,t="json"){const r=document.createElement("code");return r.textContent=e,r.className="language-"+t,Prism.highlightElement(r),r.outerHTML}}});</script></body></html>